
<!DOCTYPE html>
<html lang="zh-cn,en,default">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Salmons&#39;s Pool">
    <title>ç†è§£OCè¿è¡Œæ—¶ - Salmons&#39;s Pool</title>
    <meta name="author" content="Salmons">
    
    
        <link rel="icon" href="http://salmons.info/assets/images/favicon.ico">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Salmons","sameAs":[],"image":"favicon.ico"},"articleBody":"ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»Cè½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™å­¦åˆ°çš„ï¼Œåœ¨è¿™é‡Œåšä¸€ä¸‹æ€»ç»“å’Œå¿ƒå¾—ğŸ˜ã€‚\n\n\nã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹ \n\n\nã€ŠEffective Objective-C 2.0  ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•ã€‹\nç®€ä»‹Objective-Cæ˜¯åŸºäºCè¯­è¨€åŠ å…¥äº†é¢å‘å¯¹è±¡ç‰¹æ€§å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶çš„åŠ¨æ€è¯­è¨€ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä»…éœ€è¦ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œè¿˜éœ€è¦Runtimeç³»ç»Ÿæ¥åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡ï¼Œè¿›è¡Œæ¶ˆæ¯å‘é€å’Œè½¬å‘ã€‚\nRuntimeåˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚çš„C è¯­è¨€ APIï¼Œæ˜¯ iOS ç³»ç»Ÿçš„æ ¸å¿ƒä¹‹ä¸€ã€‚å¼€å‘è€…åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç»™ä»»æ„ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µåªæ˜¯ç¡®å®šäº†è¦å‘æ¥æ”¶è€…å‘é€è¿™æ¡æ¶ˆæ¯ï¼Œè€Œæ¥å—è€…å°†è¦å¦‚ä½•å“åº”å’Œå¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œé‚£å°±è¦çœ‹è¿è¡Œæ—¶æ¥å†³å®šäº†ã€‚\nCè¯­è¨€ä¸­ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå‡½æ•°çš„è°ƒç”¨å°±ä¼šå†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚è€ŒOCçš„å‡½æ•°ï¼Œå±äºåŠ¨æ€è°ƒç”¨è¿‡ç¨‹ï¼Œåœ¨ç¼–è¯‘æœŸå¹¶ä¸èƒ½å†³å®šçœŸæ­£è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œåªæœ‰åœ¨çœŸæ­£è¿è¡Œæ—¶æ‰ä¼šæ ¹æ®å‡½æ•°çš„åç§°æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æ¥è°ƒç”¨ã€‚\nåœ¨Objective-Cä¸­ï¼Œä½¿ç”¨[receiver message]è¯­æ³•å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œreceiverå¯¹è±¡çš„messageæ–¹æ³•çš„ä»£ç ï¼Œè€Œæ˜¯å‘receiverå‘é€ä¸€æ¡messageæ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯å¯èƒ½ç”±receiveræ¥å¤„ç†ï¼Œä¹Ÿå¯èƒ½ç”±è½¬å‘ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ï¼Œä¹Ÿæœ‰å¯èƒ½å‡è£…æ²¡æœ‰æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯è€Œæ²¡æœ‰å¤„ç†ã€‚å…¶å®[receiver message]è¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸º:\nid objc_msgSend ( id self, SEL op, ... );\nåè¯è§£é‡ŠNSObjectã€idæ¯å½“ä½ codingçš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰å‘ç°ä½ åˆ›å»ºçš„æ‰€æœ‰çš„ç±»åˆ°æœ€åéƒ½æ˜¯ä»¥NSObjectä¸ºåŸºç±»ï¼Œä¸ç›¸ä¿¡çš„è¯å°±æŒ‰ä½commandé”®ï¼Œä¸€æ­¥ä¸€æ­¥çš„ç‚¹ï¼Œç‚¹åˆ°ä¸èƒ½ç‚¹ï¼ï¼ˆNSProxyå‡ ä¸ªç‰¹æ®Šçš„é™¤å¤–ï¼‰ï¼Œç„¶åæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹NSObjectã€‚\nAppleç»´æŠ¤çš„ä¸€ä»½è¿è¡Œæ—¶æºç : objc4-680\nä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘æŠŠæºç éƒ½è´´åœ¨ä¸€èµ·äº†ï¼Œçœ‹å‡ ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š\n12345678910111213141516171819202122232425262728293031323334353637383940414243typedef struct objc_class *Class;//objc_objectè¿™æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„idç±»å‹ï¼ŒæŒ‡å‘çš„ç±»å‹ä¸å±€é™äºNSObjectï¼Œè­¬å¦‚NSProxytypedef struct objc_object *id;//NSObject * å°±æ˜¯ NSObjectç±»å‹çš„æŒ‡é’ˆäº†ï¼Œå®ƒèŒƒå›´è¾ƒå°ã€‚@interface NSObject &lt;NSObject&gt; &#123;    Class isa  OBJC_ISA_AVAILABILITY;&#125;@interface Object &#123;     Class isa; &#125;@interface NSObject &lt;NSObject&gt; &#123;    Class isa  OBJC_ISA_AVAILABILITY;&#125;struct objc_object &#123;private:\t //ä½ ä¼šå‘ç°isa_tæ˜¯ä¸ªunion    isa_t isa;&#125;struct objc_class : objc_object &#123;    // Class ISA;    Class superclass;    cache_t cache;             // formerly cache pointer and vtable    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags&#125;typedef struct objc_object &#123;    Class isa;&#125; *id;union isa_t &#123;    isa_t() &#123; &#125;    isa_t(uintptr_t value) : bits(value) &#123; &#125;    Class cls;    uintptr_t bits;&#125;\nç”±æ­¤å¯è§struct objc_class : objc_object objc_classç»§æ‰¿äºobjc_object\nobjc_classå½“ç„¶ä¹Ÿä¼šåŒ…å«ç›¸åŒçš„isaç»“æ„ä½“ï¼ŒClassæ˜¯objc_class` typedefè¿‡æ¥çš„ï¼Œåˆæœ‰ç€ç»§æ‰¿å…³ç³»ã€‚æ‰€ä»¥Class`æœ¬èº«ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ã€‚\nobjc_classä¸­å…¶ä»–æˆå‘˜ï¼šçœ‹åå­—ç†è§£ï¼Œçˆ¶ç±»superclassï¼Œæ–¹æ³•ç¼“å­˜cacheï¼Œæœ€åä¸€ä¸ªä¸å®¹æ˜“çœ‹ï¼Œæˆ‘å…ˆè¯´ä¸‹æ˜¯å½“å‰ç±»çš„å®ä¾‹æ–¹æ³•çš„ä¸€ä¸ªé›†åˆã€‚\nisaå…ˆè¯´ isaè¡¨ç¤ºä¸€ä¸ªClasså¯¹è±¡çš„Classï¼Œä¹Ÿå°±æ˜¯Meta Classã€‚åœ¨é¢å‘å¯¹è±¡è®¾è®¡ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼ŒClassåœ¨è®¾è®¡ä¸­æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚\nå½“ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡isaæ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œç„¶ååœ¨è¯¥ç±»çš„class_data_bits_tï¼ˆä¸Šæ–‡ä¸­objc_classçš„æˆå‘˜ï¼‰ä¸­å»æŸ¥æ‰¾æ–¹æ³•ã€‚class_data_bits_tæ˜¯æŒ‡å‘äº†ç±»å¯¹è±¡çš„æ•°æ®åŒºåŸŸã€‚åœ¨è¯¥æ•°æ®åŒºåŸŸå†…æŸ¥æ‰¾ç›¸åº”æ–¹æ³•çš„å¯¹åº”å®ç°ã€‚\nå¦‚æœæ˜¯ç±»æ–¹æ³•å‘¢ï¼Ÿå½“ç„¶ä¹Ÿæ˜¯é€šè¿‡isaäº†ã€‚\n123`å¯¹è±¡çš„å®ä¾‹æ–¹æ³•` â€”â€” &gt;  `isa` â€”â€” &gt; `å¯¹è±¡æ‰€å±ç±»``ç±»æ–¹æ³•` â€”â€” &gt; `isa` â€”â€” &gt; `â“`\nä¸Šé¢è¯´äº†ç±»ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ã€‚é‚£å°±è®©isaåœ¨ç±»å¯¹è±¡æ‰€å±çš„ç±»ä¸­æ‰¾ã€‚æˆ‘ä»¬å«å®ƒçŒ¿ç±»ï¼Œä¸å¥½æ„æ€æ‰“é”™äº†ï¼Œå…ƒç±»Meta Classã€‚\nä¸‹å›¾å¾ˆå¥½è§£é‡Šäº†å¯¹è±¡ï¼Œç±»ï¼Œå…ƒç±»ä¹‹é—´çš„å…³ç³»ã€‚ \n\nè§£é‡Šä¸€ä¸‹è¿™ä¸ªå›¾ï¼š å®çº¿æ˜¯super_classæŒ‡é’ˆï¼Œè™šçº¿æ˜¯isaæŒ‡é’ˆã€‚\n\nRoot Classæ˜¯NSObjectï¼Œ NSObjectæ˜¯æ²¡æœ‰è¶…ç±»çš„ï¼Œæ‰€ä»¥Root class(class)çš„superclassæŒ‡å‘nilã€‚\næ¯ä¸ªClasséƒ½æœ‰ä¸€ä¸ªisaæŒ‡é’ˆæŒ‡å‘å”¯ä¸€çš„Meta class\nRoot class(meta)çš„superclassæŒ‡å‘Root class(class)ï¼Œä¹Ÿå°±æ˜¯NSObjectï¼Œå½¢æˆä¸€ä¸ªå›è·¯ã€‚\næ¯ä¸ªMeta classçš„isaæŒ‡é’ˆéƒ½æŒ‡å‘Root class (meta)ã€‚\n\nisaçš„ç±»å‹æ˜¯isa_tã€‚ æºç isa_tæ˜¯ä¸ªè”åˆ\n1234567union isa_t &#123;    isa_t() &#123; &#125;    isa_t(uintptr_t value) : bits(value) &#123; &#125;    Class cls;    uintptr_t bits;&#125;\nå¯¹äºisa_tçš„æ·±å…¥äº†è§£ï¼Œæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼æŠ±æ­‰å“ˆğŸ¶\næ‡‚äº†ä¸Šå›¾å’Œå…ƒç±»çš„æ¦‚å¿µå°±å¯ä»¥äº†ã€‚\néšè—å‚æ•°selfå’Œ_cmdå½“[receiver message]è°ƒç”¨æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨è¿è¡Œæ—¶å·å·åœ°åŠ¨æ€ä¼ å…¥ä¸¤ä¸ªéšè—å‚æ•°selfå’Œ_cmdï¼Œä¹‹æ‰€ä»¥ç§°å®ƒä»¬ä¸ºéšè—å‚æ•°ï¼Œæ˜¯å› ä¸ºåœ¨æºä»£ç ä¸­æ²¡æœ‰å£°æ˜å’Œå®šä¹‰è¿™ä¸¤ä¸ªå‚æ•°ã€‚è‡³äºå¯¹äºselfçš„æè¿°ï¼Œä¸Šé¢å·²ç»è§£é‡Šéå¸¸æ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹è®²è§£_cmdã€‚\n_cmdè¡¨ç¤ºå½“å‰è°ƒç”¨æ–¹æ³•ï¼Œå…¶å®å®ƒå°±æ˜¯ä¸€ä¸ªæ–¹æ³•é€‰æ‹©å™¨SELï¼ˆä¸‹æ–‡æåˆ°ï¼‰ã€‚ä¸€èˆ¬ç”¨äºåˆ¤æ–­æ–¹æ³•åæˆ–åœ¨Associated Objectsä¸­å”¯ä¸€æ ‡è¯†é”®åï¼Œåé¢åœ¨Associated Objectsä¼šè®²åˆ°ã€‚\nself å’Œ superselfè¡¨ç¤ºå½“å‰è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œè€Œsuperæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ ‡ç¤ºç¬¦ï¼Œå’ŒselfæŒ‡å‘åŒä¸€ä¸ªæ¶ˆæ¯æ¥å—è€…ã€‚\nè­¬å¦‚[self class]å’Œ[super class]ï¼Œæ¥å—æ¶ˆæ¯è€…éƒ½æ˜¯å½“å‰è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œä½†superä¸selfä¸åŒçš„æ˜¯ï¼Œselfè°ƒç”¨classæ–¹æ³•æ—¶ï¼Œæ˜¯åœ¨å­ç±»ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè€Œsuperè°ƒç”¨classæ–¹æ³•æ—¶ï¼Œæ˜¯åœ¨çˆ¶ç±»ä¸­æŸ¥æ‰¾æ–¹æ³•ã€‚\nåˆè­¬å¦‚å½“è°ƒç”¨[self class]æ–¹æ³•æ—¶ï¼Œä¼šè½¬åŒ–ä¸ºobjc_msgSendå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\nid objc_msgSend(id self, SEL op, ...)\nè¿™æ—¶ä¼šä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åˆ°çˆ¶ç±»æŸ¥æ‰¾ï¼Œè¿˜æ˜¯æ²¡æœ‰ï¼Œæœ€ååœ¨NSObjectç±»æŸ¥æ‰¾åˆ°ã€‚æˆ‘ä»¬å¯ä»¥ä»NSObject.mæ–‡ä»¶ä¸­çœ‹åˆ°- (Class)classçš„å®ç°ï¼š\n123- (Class)class &#123;    return object_getClass(self);&#125;\nåˆè­¬å¦‚å½“è°ƒç”¨[super class]æ–¹æ³•æ—¶ï¼Œä¼šè½¬åŒ–ä¸ºobjc_msgSendSuperï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š\nid objc_msgSendSuper(struct objc_super *super, SEL op, ...)\nobjc_msgSendSuperå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°superçš„æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡å‘objc_superçš„ç»“æ„ä½“ï¼Œä»message.hæ–‡ä»¶ä¸­æŸ¥çœ‹å®ƒçš„å®šä¹‰ï¼š\n123456789101112131415/// Specifies the superclass of an instance. struct objc_super &#123;    /// Specifies an instance of a class.    __unsafe_unretained id receiver;    /// Specifies the particular superclass of the instance to message. #if !defined(__cplusplus)  &amp;&amp;  !__OBJC2__    /* For compatibility with old objc-runtime.h header */    __unsafe_unretained Class class;#else    __unsafe_unretained Class super_class;#endif    /* super_class is the first class to search */&#125;;#endif\nç»“æ„ä½“åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯receiverï¼Œè¡¨ç¤ºæŸä¸ªç±»çš„å®ä¾‹ã€‚ç¬¬äºŒä¸ªæ˜¯super_classè¡¨ç¤ºå½“å‰ç±»çš„çˆ¶ç±»ã€‚\nè¿™æ—¶é¦–å…ˆä¼šæ„é€ å‡ºobjc_superç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯selfï¼Œç¬¬äºŒä¸ªæˆå‘˜æ˜¯(id)class_getSuperclass(objc_getClass(&quot;Class&quot;))ï¼Œå®é™…ä¸Šè¯¥å‡½æ•°ä¼šè¾“å‡ºSuperClassã€‚ç„¶ååœ¨çˆ¶ç±»æŸ¥æ‰¾classæ–¹æ³•ï¼ŒæŸ¥æ‰¾ä¸åˆ°ï¼Œæœ€ååœ¨NSObjectæŸ¥åˆ°ã€‚æ­¤æ—¶ï¼Œå†…éƒ¨ä½¿ç”¨objc_msgSend(objc_super-&gt;receiver, @selector(class))å»è°ƒç”¨ï¼Œä¸[self class]è°ƒç”¨ç›¸åŒï¼Œæ‰€ä»¥ç»“æœè¿˜æ˜¯å½“å‰ç±»ã€‚\nIvarIvarè¡¨ç¤ºç±»ä¸­çš„å®ä¾‹å˜é‡ï¼Œåœ¨runtime.hæ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š\n1234567891011/// An opaque type that represents an instance variable.typedef struct objc_ivar *Ivar;struct objc_ivar &#123;    char *ivar_name                                          OBJC2_UNAVAILABLE;    char *ivar_type                                          OBJC2_UNAVAILABLE;    int ivar_offset                                          OBJC2_UNAVAILABLE;#ifdef __LP64__    int space                                                OBJC2_UNAVAILABLE;#endif&#125;\nIvarå…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡å‘objc_ivarç»“æ„ä½“æŒ‡é’ˆï¼Œå®ƒåŒ…å«äº†å˜é‡å(ivar_name)ã€å˜é‡ç±»å‹(ivar_type)ç­‰ä¿¡æ¯ã€‚\nSELSELç§°æ–¹æ³•é€‰æ‹©å™¨\né€šä¿—è¯æ¥è®²ï¼ŒisaæŒ‡é’ˆæŒ‡å‘çš„ç±»çš„ç»“æ„ä½“ä¸­æœ‰è¿™æ ·ä¸€å¼ SELå’ŒIMPå¯¹åº” çš„Dispatch tableã€‚ä½ æ‰¾åˆ°äº†SELï¼Œæœ€åè¿˜æ˜¯è¦é€šè¿‡è¿™ä¸ªtableæ‰¾åˆ°IMPã€‚SELåªæ˜¯ä¸€ä¸ªæ–¹æ³•ç¼–å·ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„æ–¹æ³•å®ç°åœ°å€ã€‚\nSELè¦è¯´çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœç±»ä¸åŒï¼Œä½†æ˜¯æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œä»–ä»¬å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„ï¼Œå³ä½¿å‚æ•°çš„ç±»å‹ä¸åŒï¼Œä»–ä»¬å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥Objective-Cä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œæœ‰å…³ä»€ä¹ˆæ˜¯å‡½æ•°é‡è½½å¯ä»¥äº†è§£ä¸‹C++\næ¥å—è€…receiveræ”¶åˆ°å¯¹åº”çš„selectorï¼Œå¦‚æœæœ‰ä¸èƒ½æ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æƒ…å†µï¼Œè¿™æ¡messageè¦è¢«è½¬å‘ï¼Œæˆ–è€…åˆ©ç”¨runtimeåŠ¨æ€æ·»åŠ è¿™ä¸ªæ–¹æ³•çš„å®ç°æ¥æ­£å¸¸æ‰§è¡Œã€‚å¦‚æœæ­£å¸¸æ‰§è¡Œæˆ–è€…è½¬å‘éƒ½å¤±è´¥ã€‚ç¨‹åºä¼šcrash\næ‰€ä»¥OCè¿™é—¨è¿è¡Œæ—¶è¯­è¨€åœ¨ç¼–è¯‘æœŸåªç¡®å®šäº†å‘æ¶ˆæ¯ï¼Œæ¥å—è€…å¦‚ä½•å“åº”æˆ–è€…å¤„ç†æ¶ˆæ¯æ˜¯åœ¨è¿è¡Œæ—¶runtimeå†³å®šï¼Œæ‰€ä»¥å’ŒCè¯­è¨€ä¸åŒï¼Œä¸å£°æ˜æ–¹æ³•ï¼Œç¨‹åºç¼–è¯‘ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚\nIMPIMPæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•çš„å®ç°ï¼Œåœ¨objc.hæ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š\n123456/// A pointer to the function of a method implementation. #if !OBJC_OLD_DISPATCH_PROTOTYPEStypedef void (*IMP)(void /* id, SEL, ... */ ); #elsetypedef id (*IMP)(id, SEL, ...); #endif\nå½“ä½ å‘æŸä¸ªå¯¹è±¡å‘é€ä¸€æ¡ä¿¡æ¯ï¼Œå¯ä»¥ç”±è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ¥æŒ‡å®šæ–¹æ³•çš„å®ç°ï¼Œå®ƒæœ€ç»ˆå°±ä¼šæ‰§è¡Œé‚£æ®µä»£ç ï¼Œè¿™æ ·å¯ä»¥ç»•å¼€æ¶ˆæ¯ä¼ é€’é˜¶æ®µè€Œå»æ‰§è¡Œå¦ä¸€ä¸ªæ–¹æ³•å®ç°ã€‚\nè¯´å¥å¤§ç™½è¯ï¼Œæ‹¿åˆ°äº†IMPï¼Œæ‰èƒ½åƒä½¿ç”¨Cè¯­è¨€å‡½æ•°æŒ‡é’ˆä¸€æ ·è‚†æ— å¿Œæƒ®ã€‚\nMethodMethodè¡¨ç¤ºç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œåœ¨runtime.hæ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š\n12345678/// An opaque type that represents a method in a class definition.typedef struct objc_method *Method;struct objc_method &#123;    SEL method_name                                          OBJC2_UNAVAILABLE;    char *method_types                                       OBJC2_UNAVAILABLE;    IMP method_imp                                           OBJC2_UNAVAILABLE;&#125;\nå…¶å®Methodå°±æ˜¯ä¸€ä¸ªæŒ‡å‘objc_methodç»“æ„ä½“æŒ‡é’ˆï¼Œå®ƒå­˜å‚¨äº†æ–¹æ³•å(method_name)ã€æ–¹æ³•ç±»å‹(method_types)å’Œæ–¹æ³•å®ç°(method_imp)ç­‰ä¿¡æ¯ã€‚\nå¤§ç™½è¯å°±æ˜¯ï¼šMethodè¡¨ç¤ºä¸€ç§ç±»å‹ï¼Œè¿™ç§ç±»å‹ä¸SELå’Œå®ç°IMPç›¸å…³ã€‚\nCacheCacheä¸»è¦ç”¨æ¥ç¼“å­˜ï¼Œé‚£å®ƒç¼“å­˜ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å…ˆåœ¨runtime.hæ–‡ä»¶çœ‹çœ‹å®ƒçš„å®šä¹‰ï¼š\n1234567typedef struct objc_cache *Cache                             OBJC2_UNAVAILABLE;struct objc_cache &#123;    unsigned int mask /* total = mask + 1 */                 OBJC2_UNAVAILABLE;    unsigned int occupied                                    OBJC2_UNAVAILABLE;    Method buckets[1]                                        OBJC2_UNAVAILABLE;&#125;;\nCacheå…¶å®å°±æ˜¯ä¸€ä¸ªå­˜å‚¨Methodçš„é“¾è¡¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–æ–¹æ³•è°ƒç”¨çš„æ€§èƒ½ã€‚å½“å¯¹è±¡receiverè°ƒç”¨æ–¹æ³•messageæ—¶ï¼Œé¦–å…ˆæ ¹æ®å¯¹è±¡receiverçš„isaæŒ‡é’ˆæŸ¥æ‰¾åˆ°å®ƒå¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨ç±»çš„methodListsä¸­æœç´¢æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä½¿ç”¨super_classæŒ‡é’ˆåˆ°çˆ¶ç±»ä¸­çš„methodListsæŸ¥æ‰¾ï¼Œä¸€æ—¦æ‰¾åˆ°å°±è°ƒç”¨æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæœ‰å¯èƒ½æ¶ˆæ¯è½¬å‘ï¼Œä¹Ÿå¯èƒ½å¿½ç•¥å®ƒã€‚ä½†è¿™æ ·æŸ¥æ‰¾æ–¹å¼æ•ˆç‡å¤ªä½ï¼Œå› ä¸ºå¾€å¾€ä¸€ä¸ªç±»å¤§æ¦‚åªæœ‰20%çš„æ–¹æ³•ç»å¸¸è¢«è°ƒç”¨ï¼Œå æ€»è°ƒç”¨æ¬¡æ•°çš„80%ã€‚æ‰€ä»¥ä½¿ç”¨Cacheæ¥ç¼“å­˜ç»å¸¸è°ƒç”¨çš„æ–¹æ³•ï¼Œå½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼˜å…ˆåœ¨CacheæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†åˆ°methodListsæŸ¥æ‰¾ã€‚\nå…³äº SEL, IMP, Methodçš„ç†è§£ï¼Œç†è§£çš„ä¸å¥½çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« http://blog.csdn.net/fengsh998/article/details/8614486\nRuntimeåŸç†objc_msgSendå‡½æ•°æ˜¯å¦‚ä½•å‘é€æ¶ˆæ¯çš„\né¦–å…ˆæ ¹æ®receiverå¯¹è±¡çš„isaæŒ‡é’ˆè·å–å®ƒå¯¹åº”çš„class\nä¼˜å…ˆåœ¨classçš„cacheæŸ¥æ‰¾messageæ–¹æ³•ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå†åˆ°methodListsæŸ¥æ‰¾\nå¦‚æœæ²¡æœ‰åœ¨classæ‰¾åˆ°ï¼Œå†åˆ°super_classæŸ¥æ‰¾\nä¸€æ—¦æ‰¾åˆ°messageè¿™ä¸ªæ–¹æ³•ï¼Œå°±æ‰§è¡Œå®ƒå®ç°çš„IMPã€‚ç¼“å­˜åˆ°cacheé‡Œé¢ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨\n\næ¶ˆæ¯å‘é€å’Œè½¬å‘[receiver message]è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¦‚æœåœ¨messageæ–¹æ³•åœ¨receiverå¯¹è±¡çš„ç±»ç»§æ‰¿ä½“ç³»ä¸­æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶å°±ä¼šCrashæ‰ï¼ŒæŠ›å‡º unrecognized selector sent to â€¦ç±»ä¼¼è¿™æ ·çš„å¼‚å¸¸ä¿¡æ¯ã€‚ä½†åœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œè¿˜æœ‰ä¸‰æ¬¡æœºä¼šæŒ‰ä»¥ä¸‹é¡ºåºè®©ä½ æ‹¯æ•‘ç¨‹åºã€‚\nMethod Resolutioné¦–å…ˆOCåœ¨è¿è¡Œæ—¶è°ƒç”¨+ resolveInstanceMethod:æˆ–+ resolveClassMethod:æ–¹æ³•ï¼Œè®©ä½ æ·»åŠ æ–¹æ³•çš„å®ç°ã€‚å¦‚æœä½ æ·»åŠ æ–¹æ³•å¹¶è¿”å›YESï¼Œé‚£ç³»ç»Ÿåœ¨è¿è¡Œæ—¶å°±ä¼šé‡æ–°å¯åŠ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ã€‚\n12345@interface Message : NSObject- (void)sendMessage:(NSString *)word;@end\n12345678@implementation Message- (void)sendMessage:(NSString *)word&#123;    NSLog(@&quot;normal way : send message = %@&quot;, word);&#125;@end\nå¦‚æœæˆ‘åœ¨viewDidLoadæ–¹æ³•ä¸­åˆ›å»ºMessageå¯¹è±¡å¹¶è°ƒç”¨sendMessageæ–¹æ³•ï¼š\n123456- (void)viewDidLoad &#123;    [super viewDidLoad];    Message *message = [Message new];    [message sendMessage:@&quot;SwifterFit&quot;];&#125;\nè¾“å‡ºï¼šsend message = SwifterFit\nä½†ç°åœ¨æˆ‘å°†åŸæ¥sendMessageæ–¹æ³•å®ç°ç»™æ³¨é‡Šæ‰ï¼Œè¦†ç›–resolveInstanceMethodæ–¹æ³•ï¼š\n12345678910111213#pragma mark - Method Resolution/// override resolveInstanceMethod or resolveClassMethod for changing sendMessage method implementation+ (BOOL)resolveInstanceMethod:(SEL)sel&#123;    if (sel == @selector(sendMessage:)) &#123;        class_addMethod([self class], sel, imp_implementationWithBlock(^(id self, NSString *word) &#123;            NSLog(@&quot;method resolution way : send message = %@&quot;, word);        &#125;), &quot;v@*&quot;);    &#125;    return YES;&#125;\nè¾“å‡ºï¼šsend message = SwifterFit\nå¦‚æœresolveInstanceMethodæ–¹æ³•è¿”å›NOï¼Œè¿è¡Œæ—¶å°±è·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼šæ¶ˆæ¯è½¬å‘Message Forwarding\nFast Forwardingå¦‚æœç›®æ ‡å¯¹è±¡å®ç°- forwardingTargetForSelector:æ–¹æ³•ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡Œæ—¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåªè¦è¿™ä¸ªæ–¹æ³•è¿”å›çš„ä¸æ˜¯nilæˆ–selfï¼Œä¹Ÿä¼šé‡å¯æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ï¼ŒæŠŠè¿™æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ã€‚å¦åˆ™ï¼Œå°±ä¼šç»§ç»­Normal Fowardingã€‚\nç»§ç»­ä¸Šé¢Messageç±»çš„ä¾‹å­ï¼Œå°†sendMessageå’ŒresolveInstanceMethodæ–¹æ³•æ³¨é‡Šæ‰ï¼Œç„¶åæ·»åŠ forwardingTargetForSelectoræ–¹æ³•çš„å®ç°ï¼š\nå°†sendMessageå’ŒresolveInstanceMethodæ–¹æ³•æ³¨é‡Šæ‰ï¼Œç„¶åæ·»åŠ forwardingTargetForSelectoræ–¹æ³•çš„å®ç°ï¼š\n123456789#pragma mark - Fast Forwarding- (id)forwardingTargetForSelector:(SEL)aSelector&#123;    if (aSelector == @selector(sendMessage:)) &#123;        return [MessageForwarding new];    &#125;    return nil;&#125;\næ­¤æ—¶è¿˜ç¼ºä¸€ä¸ªè½¬å‘æ¶ˆæ¯çš„ç±»MessageForwardingï¼Œè¿™ä¸ªç±»çš„è®¾è®¡ä¸å®ç°å¦‚ä¸‹ï¼š\n12345@interface MessageForwarding : NSObject- (void)sendMessage:(NSString *)word;@end\n12345678@implementation MessageForwarding- (void)sendMessage:(NSString *)word&#123;    NSLog(@&quot;fast forwarding way : send message = %@&quot;, word);&#125;@end\nè¿™é‡Œå«Fastï¼Œæ˜¯å› ä¸ºè¿™ä¸€æ­¥ä¸ä¼šåˆ›å»ºNSInvocationå¯¹è±¡ï¼Œä½†Normal Forwardingä¼šåˆ›å»ºå®ƒï¼Œæ‰€ä»¥ç›¸å¯¹äºæ›´å¿«ç‚¹ã€‚\nNormal Forwardingå¦‚æœæ²¡æœ‰ä½¿ç”¨Fast Forwardingæ¥æ¶ˆæ¯è½¬å‘ï¼Œæœ€ååªæœ‰ä½¿ç”¨Normal Forwardingæ¥è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚å®ƒé¦–å…ˆè°ƒç”¨methodSignatureForSelector:æ–¹æ³•æ¥è·å–å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œå¦‚æœè¿”å›ä¸ºnilï¼Œç¨‹åºä¼šCrashæ‰ï¼Œå¹¶æŠ›å‡ºunrecognized selector sent to instanceå¼‚å¸¸ä¿¡æ¯ã€‚å¦‚æœè¿”å›ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œç³»ç»Ÿå°±ä¼šåˆ›å»ºä¸€ä¸ªNSInvocationå¯¹è±¡å¹¶è°ƒç”¨-forwardInvocation:æ–¹æ³•ã€‚\nç»§ç»­å‰é¢çš„ä¾‹å­ï¼Œå°†forwardingTargetForSelectoræ–¹æ³•æ³¨é‡Šæ‰ï¼Œæ·»åŠ methodSignatureForSelectorå’ŒforwardInvocationæ–¹æ³•çš„å®ç°ï¼š\n1234567891011121314151617181920#pragma mark - Normal Forwarding- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector&#123;    NSMethodSignature *methodSignature = [super methodSignatureForSelector:aSelector];    if (!methodSignature) &#123;        methodSignature = [NSMethodSignature signatureWithObjCTypes:&quot;v@:*&quot;];    &#125;    return methodSignature;&#125;- (void)forwardInvocation:(NSInvocation *)anInvocation&#123;    MessageForwarding *messageForwarding = [MessageForwarding new];    if ([messageForwarding respondsToSelector:anInvocation.selector]) &#123;        [anInvocation invokeWithTarget:messageForwarding];    &#125;&#125;\nRuntimeæä¾›ä¸‰ç§æ–¹å¼æ¥å°†åŸæ¥çš„æ–¹æ³•å®ç°ä»£æ›¿æ‰ï¼Œé‚£è¯¥æ€æ ·é€‰æ‹©å®ƒä»¬å‘¢ï¼Ÿ\n\nMethod Resolutionï¼šç”±äºMethod Resolutionä¸èƒ½åƒæ¶ˆæ¯è½¬å‘é‚£æ ·å¯ä»¥äº¤ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ï¼Œæ‰€ä»¥åªé€‚ç”¨äºåœ¨åŸæ¥çš„ç±»ä¸­ä»£æ›¿æ‰ã€‚\nFast Forwardingï¼šå®ƒå¯ä»¥å°†æ¶ˆæ¯å¤„ç†è½¬å‘ç»™å…¶ä»–å¯¹è±¡ï¼Œä½¿ç”¨èŒƒå›´æ›´å¹¿ï¼Œä¸åªæ˜¯é™äºåŸæ¥çš„å¯¹è±¡ã€‚\nNormal Forwardingï¼šå®ƒè·ŸFast Forwardingä¸€æ ·å¯ä»¥æ¶ˆæ¯è½¬å‘ï¼Œä½†å®ƒèƒ½é€šè¿‡NSInvocationå¯¹è±¡è·å–æ›´å¤šæ¶ˆæ¯å‘é€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼štargetã€selectorã€argumentså’Œè¿”å›å€¼ç­‰ä¿¡æ¯ã€‚\n\nRuntimeåº”ç”¨ä¸ºCategoryæ·»åŠ å±æ€§property\nAssociated Objects\n\nå½“æƒ³ä½¿ç”¨Categoryå¯¹å·²å­˜åœ¨çš„ç±»è¿›è¡Œæ‰©å±•æ—¶ï¼Œä¸€èˆ¬åªèƒ½æ·»åŠ å®ä¾‹æ–¹æ³•æˆ–ç±»æ–¹æ³•ï¼Œè€Œä¸é€‚åˆæ·»åŠ é¢å¤–çš„å±æ€§ã€‚è™½ç„¶å¯ä»¥åœ¨Categoryå¤´æ–‡ä»¶ä¸­å£°æ˜propertyå±æ€§ï¼Œä½†åœ¨å®ç°æ–‡ä»¶ä¸­ç¼–è¯‘å™¨æ˜¯æ— æ³•synthesizeä»»ä½•å®ä¾‹å˜é‡å’Œå±æ€§è®¿é—®æ–¹æ³•ã€‚è¿™æ—¶éœ€è¦è‡ªå®šä¹‰å±æ€§è®¿é—®æ–¹æ³•å¹¶ä¸”ä½¿ç”¨Associated Objectsæ¥ç»™å·²å­˜åœ¨çš„ç±»Categoryæ·»åŠ è‡ªå®šä¹‰çš„å±æ€§ã€‚Associated Objectsæä¾›ä¸‰ä¸ªAPIæ¥å‘å¯¹è±¡æ·»åŠ ã€è·å–å’Œåˆ é™¤å…³è”å€¼ï¼š\nvoid objc_setAssociatedObject (id object, const void *key, id value, objc_AssociationPolicy policy )id objc_getAssociatedObject (id object, const void *key )void objc_removeAssociatedObjects (id object )\nå…¶ä¸­objc_AssociationPolicyæ˜¯ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå¯ä»¥æŒ‡å®šObjcå†…å­˜ç®¡ç†çš„å¼•ç”¨è®¡æ•°æœºåˆ¶ã€‚\n1234567891011typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;    OBJC_ASSOCIATION_ASSIGN = 0,           /**&lt; Specifies a weak reference to the associated object. */    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object.                                             *   The association is not made atomically. */    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**&lt; Specifies that the associated object is copied.                                             *   The association is not made atomically. */    OBJC_ASSOCIATION_RETAIN = 01401,       /**&lt; Specifies a strong reference to the associated object.                                            *   The association is made atomically. */    OBJC_ASSOCIATION_COPY = 01403          /**&lt; Specifies that the associated object is copied.                                            *   The association is made atomically. */&#125;;\nä¸‹é¢æœ‰ä¸ªå…³äºNSObject+AssociatedObject Categoryæ·»åŠ å±æ€§associatedObjectçš„ç¤ºä¾‹ä»£ç :\n12345@interface NSObject (AssociatedObject)@property (strong, nonatomic) id associatedObject;@end\n12345678910111213@implementation NSObject (AssociatedObject)- (void)setAssociatedObject:(id)associatedObject&#123;    objc_setAssociatedObject(self, @selector(associatedObject), associatedObject, OBJC_ASSOCIATION_RETAIN_NONATOMIC);&#125;- (id)associatedObject&#123;    return objc_getAssociatedObject(self, _cmd);&#125;@end\nAssociated Objectsçš„keyè¦æ±‚æ˜¯å”¯ä¸€å¹¶ä¸”æ˜¯å¸¸é‡ï¼Œè€ŒSELæ˜¯æ»¡è¶³è¿™ä¸ªè¦æ±‚çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„é‡‡ç”¨éšè—å‚æ•°_cmdä½œä¸ºkeyã€‚\nMethod Swizzlingæåˆ°Objective-C ä¸­çš„ Runtimeï¼Œå¤§å¤šæ•°äººç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯é»‘é­”æ³•Method Swizzlingã€‚æ¯•ç«Ÿè¿™æ˜¯Runtimeé‡Œé¢å¾ˆå¼ºå¤§çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥é€šè¿‡Runtimeçš„APIå®ç°æ›´æ”¹ä»»æ„çš„æ–¹æ³•ï¼Œç†è®ºä¸Šå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ç±»å/æ–¹æ³•åhookåˆ°ä»»ä½• OCæ–¹æ³•ï¼Œæ›¿æ¢ä»»ä½•ç±»çš„å®ç°ä»¥åŠæ–°å¢ä»»æ„ç±»ã€‚\nä¸¾çš„æœ€å¤šçš„ä¾‹å­åº”è¯¥å°±æ˜¯åŸ‹ç‚¹ç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯çš„ä¾‹å­ã€‚\nå‡è®¾æˆ‘ä»¬éœ€è¦åœ¨é¡µé¢ä¸Šä¸åŒçš„åœ°æ–¹ç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯ï¼Œå¸¸è§åšæ³•æœ‰ä¸¤ç§ï¼š\n\nå‚»ç“œå¼çš„åœ¨æ‰€æœ‰éœ€è¦ç»Ÿè®¡çš„é¡µé¢éƒ½åŠ ä¸Šä»£ç ã€‚è¿™æ ·åšç®€å•ï¼Œä½†æ˜¯é‡å¤çš„ä»£ç å¤ªå¤šã€‚\næŠŠç»Ÿè®¡çš„ä»£ç å†™å…¥åŸºç±»ä¸­ï¼Œæ¯”å¦‚è¯´BaseViewControllerã€‚è¿™æ ·è™½ç„¶ä»£ç åªéœ€è¦å†™ä¸€æ¬¡ï¼Œä½†æ˜¯UITableViewControllerï¼ŒUICollectionViewcontrolleréƒ½éœ€è¦å†™ä¸€éï¼Œè¿™æ ·é‡å¤çš„ä»£ç ä¾æ—§ä¸å°‘ã€‚\n\nè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ Method Swizzlingã€‚\nMethod Swizzingæ˜¯å‘ç”Ÿåœ¨è¿è¡Œæ—¶çš„ï¼Œä¸»è¦ç”¨äºåœ¨è¿è¡Œæ—¶å°†ä¸¤ä¸ªMethodè¿›è¡Œäº¤æ¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†Method Swizzlingä»£ç å†™åˆ°ä»»ä½•åœ°æ–¹ï¼Œä½†æ˜¯åªæœ‰åœ¨è¿™æ®µMethod Swilzzlingä»£ç æ‰§è¡Œå®Œæ¯•ä¹‹åäº’æ¢æ‰èµ·ä½œç”¨ã€‚è€Œä¸”Method Swizzlingä¹Ÿæ˜¯iOSä¸­AOP(Aspect-Oriented Programming)(é¢ç›¸æ–¹é¢ç¼–ç¨‹)çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è‹¹æœè¿™ä¸€ç‰¹æ€§æ¥å®ç°AOPç¼–ç¨‹ã€‚\nMethod Swizzlingæœ¬è´¨ä¸Šå°±æ˜¯å¯¹IMPå’ŒSELè¿›è¡Œäº¤æ¢ã€‚\nä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨éƒ½æ˜¯æ–°å»ºä¸€ä¸ªåˆ†ç±»ï¼Œåœ¨åˆ†ç±»ä¸­è¿›è¡ŒMethod Swizzlingæ–¹æ³•çš„äº¤æ¢ã€‚äº¤æ¢çš„ä»£ç æ¨¡æ¿å¦‚ä¸‹ï¼š\n1234567891011121314151617181920212223242526272829303132#import &lt;objc/runtime.h&gt;@implementation UIViewController (Swizzling)+ (void)load &#123;    static dispatch_once_t onceToken;    dispatch_once(&amp;onceToken, ^&#123;        Class class = [self class];        // When swizzling a class method, use the following:        // Class class = object_getClass((id)self);        SEL originalSelector = @selector(viewWillAppear:);        SEL swizzledSelector = @selector(xxx_viewWillAppear:);        Method originalMethod = class_getInstanceMethod(class, originalSelector);        Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);        BOOL didAddMethod = class_addMethod(class,                                            originalSelector,                                            method_getImplementation(swizzledMethod),                                            method_getTypeEncoding(swizzledMethod));        if (didAddMethod) &#123;            class_replaceMethod(class,                                swizzledSelector,                                method_getImplementation(originalMethod),                                method_getTypeEncoding(originalMethod));        &#125; else &#123;            method_exchangeImplementations(originalMethod, swizzledMethod);        &#125;    &#125;);&#125;#pragma mark - Method Swizzling- (void)xxx_viewWillAppear:(BOOL)animated &#123;    [self xxx_viewWillAppear:animated];    NSLog(@&quot;viewWillAppear: %@&quot;, self);&#125;@end\nMethod Swizzlingå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ä¿®æ”¹ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­selectorå¯¹åº”çš„å‡½æ•°æˆ–è€…è®¾ç½®äº¤æ¢æ–¹æ³•å®ç°ï¼Œæ¥åŠ¨æ€ä¿®æ”¹æ–¹æ³•ã€‚å¯ä»¥é‡å†™æŸä¸ªæ–¹æ³•è€Œä¸ç”¨ç»§æ‰¿ï¼ŒåŒæ—¶è¿˜å¯ä»¥è°ƒç”¨åŸå…ˆçš„å®ç°ã€‚æ‰€ä»¥é€šå¸¸åº”ç”¨äºåœ¨categoryä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚\næ³¨æ„ç‚¹Swizzlingåº”è¯¥æ€»åœ¨+loadä¸­æ‰§è¡ŒObjective-Cåœ¨è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„ä¸¤ä¸ªæ–¹æ³•+loadå’Œ+initializeã€‚+loadä¼šåœ¨ç±»åˆå§‹åŠ è½½æ—¶è°ƒç”¨ï¼Œ +initializeæ–¹æ³•æ˜¯ä»¥æ‡’åŠ è½½çš„æ–¹å¼è¢«è°ƒç”¨çš„ï¼Œå¦‚æœç¨‹åºä¸€ç›´æ²¡æœ‰ç»™æŸä¸ªç±»æˆ–å®ƒçš„å­ç±»å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»çš„ +initializeæ–¹æ³•æ˜¯æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨çš„ã€‚æ‰€ä»¥Swizzlingè¦æ˜¯å†™åœ¨+initializeæ–¹æ³•ä¸­ï¼Œæ˜¯æœ‰å¯èƒ½æ°¸è¿œéƒ½ä¸è¢«æ‰§è¡Œã€‚\nå’Œ+initializeæ¯”è¾ƒ+loadèƒ½ä¿è¯åœ¨ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«åŠ è½½ã€‚\nSwizzlingåº”è¯¥æ€»æ˜¯åœ¨dispatch_onceä¸­æ‰§è¡ŒSwizzlingä¼šæ”¹å˜å…¨å±€çŠ¶æ€ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶é‡‡å–ä¸€äº›é¢„é˜²æªæ–½ï¼Œä½¿ç”¨dispatch_onceå°±èƒ½å¤Ÿç¡®ä¿ä»£ç ä¸ç®¡æœ‰å¤šå°‘çº¿ç¨‹éƒ½åªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚è¿™å°†æˆä¸ºMethod Swizzlingçš„æœ€ä½³å®è·µã€‚\nè¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œé‚£å°±æ˜¯ç»§æ‰¿ä¸­ç”¨äº†Swizzlingã€‚å¦‚æœä¸å†™dispatch_onceå°±ä¼šå¯¼è‡´Swizzlingå¤±æ•ˆï¼\nä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚åŒæ—¶å¯¹NSArrayå’ŒNSMutableArrayä¸­çš„objectAtIndex:æ–¹æ³•éƒ½è¿›è¡Œäº†Swizzlingï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´NSArrayä¸­çš„Swizzlingå¤±æ•ˆçš„ã€‚\nå¯æ˜¯ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ\nåŸå› æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ç”¨dispatch_onceæ§åˆ¶Swizzlingåªæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœè¿™æ®µSwizzlingè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œç»è¿‡å¤šæ¬¡çš„äº¤æ¢IMPå’ŒSELä¹‹åï¼Œç»“æœå¯èƒ½å°±æ˜¯æœªäº¤æ¢ä¹‹å‰çš„çŠ¶æ€ã€‚\næ¯”å¦‚è¯´çˆ¶ç±»Açš„Bæ–¹æ³•å’Œå­ç±»Cçš„Dæ–¹æ³•è¿›è¡Œäº¤æ¢ï¼Œäº¤æ¢ä¸€æ¬¡åï¼Œçˆ¶ç±»AæŒæœ‰Dæ–¹æ³•çš„IMPï¼Œå­ç±»CæŒæœ‰Bæ–¹æ³•çš„IMPï¼Œä½†æ˜¯å†æ¬¡äº¤æ¢ä¸€æ¬¡ï¼Œå°±åˆè¿˜åŸäº†ã€‚çˆ¶ç±»Aè¿˜æ˜¯æŒæœ‰Bæ–¹æ³•çš„IMPï¼Œå­ç±»Cè¿˜æ˜¯æŒæœ‰Dæ–¹æ³•çš„IMPï¼Œè¿™æ ·å°±ç›¸å½“äºå’©æœ‰äº¤æ¢ã€‚å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸å†™dispatch_onceï¼Œå¶æ•°æ¬¡äº¤æ¢ä»¥åï¼Œç›¸å½“äºæ²¡æœ‰äº¤æ¢ï¼ŒSwizzlingå¤±æ•ˆï¼\nSwizzlingåœ¨+loadä¸­æ‰§è¡Œæ—¶ï¼Œä¸è¦è°ƒç”¨[super load]åŸå› åŒæ³¨æ„ç‚¹äºŒï¼Œå¦‚æœæ˜¯å¤šç»§æ‰¿ï¼Œå¹¶ä¸”å¯¹åŒä¸€ä¸ªæ–¹æ³•éƒ½è¿›è¡Œäº†Swizzlingï¼Œé‚£ä¹ˆè°ƒç”¨[super load]ä»¥åï¼Œçˆ¶ç±»çš„Swizzlingå°±å¤±æ•ˆäº†ã€‚\nç°åœ¨æ¯”è¾ƒç«çš„hotfixï¼ŒJSPatchå°±æ˜¯åº”ç”¨äº†OCçš„runtimeç‰¹æ€§å®ç°jsä¸OCäº’é€šæ¥åŠ¨æ€ä¿®æ”¹æ–¹æ³•çš„å®ç°ã€‚\næ¯”è¾ƒå‡ºåçš„ä»¥ä¸‹æ˜¯å­—å…¸è½¬æ¨¡å‹çš„å¼€çœ¼æ¡†æ¶éƒ½åº”ç”¨äº†runtimeç‰¹æ€§ã€‚\nAppleçš„KVO ä¹Ÿä½¿ç”¨äº†runtimeçš„ç‰¹æ€§ã€‚\n\nMethod Swizzlingå°±åƒä¸€æŠŠç‘å£«å°åˆ€ï¼Œå¦‚æœä½¿ç”¨å¾—å½“ï¼Œå®ƒä¼šæœ‰æ•ˆåœ°è§£å†³é—®é¢˜ã€‚ä½†ä½¿ç”¨ä¸å½“ï¼Œå°†å¸¦æ¥å¾ˆå¤šéº»çƒ¦ã€‚åœ¨stackoverflowä¸Šæœ‰äººå·²ç»æå‡ºè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šWhat are the Dangers of Method Swizzling in Objective C?ï¼Œå®ƒçš„å±é™©æ€§ä¸»è¦ä½“ç°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\n\n\n\nMethod swizzling is not atomic\nChanges behavior of un-owned code\nPossible naming conflicts\nSwizzling changes the methodâ€™s arguments\nThe order of swizzles matters\nDifficult to understand (looks recursive)\nDifficult to debug\n\n\nç»§ç»­åŠªåŠ›å§ã€‚åŠ æ²¹ï¼\n","dateCreated":"2016-03-08T13:37:09+08:00","dateModified":"2018-12-17T13:58:42+08:00","datePublished":"2016-03-08T13:37:09+08:00","description":"ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»Cè½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™","headline":"ç†è§£OCè¿è¡Œæ—¶","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"http://salmons.info/2016/03/08/Objective-C Runtime/"},"publisher":{"@type":"Organization","name":"Salmons","sameAs":[],"image":"favicon.ico","logo":{"@type":"ImageObject","url":"favicon.ico"}},"url":"http://salmons.info/2016/03/08/Objective-C Runtime/"}</script>
    <meta name="description" content="ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»Cè½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™">
<meta property="og:type" content="blog">
<meta property="og:title" content="ç†è§£OCè¿è¡Œæ—¶">
<meta property="og:url" content="http://salmons.info/2016/03/08/Objective-C Runtime/index.html">
<meta property="og:site_name" content="Salmons&#39;s Pool">
<meta property="og:description" content="ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»Cè½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://oma38gsun.bkt.clouddn.com/meta-class.jpg">
<meta property="og:updated_time" content="2018-12-17T05:58:42.304Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ç†è§£OCè¿è¡Œæ—¶">
<meta name="twitter:description" content="ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»Cè½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™">
<meta name="twitter:image" content="http://oma38gsun.bkt.clouddn.com/meta-class.jpg">
    
    
        
    
    
        <meta property="og:image" content="http://salmons.info/assets/images/favicon.ico"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-du2xmrqdqrl2ollgeiw050kpl6l4nbyz7bumjuurjgsxyopifvukebxc9lqe.min.css">
    <!--STYLES END-->
    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Salmons&#39;s Pool</a>
    </div>
    
        
            <a class="header-right-icon " href="/">
        
        
            <i class="fa fa-home fa-lg"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/favicon.ico" alt="ä½œè€…çš„å›¾ç‰‡">
                </a>
                <h4 class="sidebar-profile-name">Salmons</h4>
                
                    <h5 class="sidebar-profile-bio"><p>life begins at the end of your comfort zone</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/ " title="é¦–é¡µ">
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">é¦–é¡µ</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-archives" title="å½’æ¡£">
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">å½’æ¡£</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-categories" title="åˆ†ç±»">
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">åˆ†ç±»</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/all-tags" title="æ ‡ç­¾">
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">æ ‡ç­¾</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="#about" title="å…³äº">
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">å…³äº</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://github.com/swifterfit" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="https://www.instagram.com/swifterfit/" target="_blank" rel="noopener" title="Instagram">
                    
                        <i class="sidebar-button-icon fab fa-instagram" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Instagram</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="mailto:swifterfit@gmail.com" target="_blank" rel="noopener" title="é‚®ç®±">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">é‚®ç®±</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a class="sidebar-button-link " href="/atom.xml" title="RSS">
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            ç†è§£OCè¿è¡Œæ—¶
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2016-03-08T13:37:09+08:00">
	
		    3æœˆ 08, 2016
    	
    </time>
    
        <span>å‘å¸ƒåœ¨ </span>
        
    <a class="category-link" href="/categories/iOS/">iOS</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>ä¸€ç›´å¯¹runtimeå¾ˆæ„Ÿå…´è¶£ï¼Œæˆ‘çŒœæ˜¯å› ä¸ºæˆ‘æ˜¯ä»<code>C</code>è½¬è¿‡æ¥çš„ï¼Œæœ‰ä¸€å®šçš„æƒ…ç»“ï¼å¾ˆå¤šå†…å®¹éƒ½æ˜¯åœ¨æˆ‘çœ‹è¿™ä¸¤æœ¬ä¹¦çš„æ—¶å€™<br><a id="more"></a><br>å­¦åˆ°çš„ï¼Œåœ¨è¿™é‡Œåšä¸€ä¸‹æ€»ç»“å’Œå¿ƒå¾—ğŸ˜ã€‚</p>
<blockquote>
</blockquote>
<p><strong>ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹</strong> </p>
<blockquote>
</blockquote>
<p><strong>ã€ŠEffective Objective-C 2.0  ç¼–å†™é«˜è´¨é‡iOSä¸OS Xä»£ç çš„52ä¸ªæœ‰æ•ˆæ–¹æ³•ã€‹</strong></p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><code>Objective-C</code>æ˜¯åŸºäº<code>C</code>è¯­è¨€åŠ å…¥äº†é¢å‘å¯¹è±¡ç‰¹æ€§å’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶çš„åŠ¨æ€è¯­è¨€ï¼Œè¿™æ„å‘³ç€å®ƒä¸ä»…éœ€è¦ä¸€ä¸ªç¼–è¯‘å™¨ï¼Œè¿˜éœ€è¦Runtimeç³»ç»Ÿæ¥åŠ¨æ€åˆ›å»ºç±»å’Œå¯¹è±¡ï¼Œè¿›è¡Œæ¶ˆæ¯å‘é€å’Œè½¬å‘ã€‚</p>
<p><code>Runtime</code>åˆå«è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€å¥—åº•å±‚çš„<code>C</code> è¯­è¨€ APIï¼Œæ˜¯ <code>iOS</code> ç³»ç»Ÿçš„æ ¸å¿ƒä¹‹ä¸€ã€‚å¼€å‘è€…åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç»™ä»»æ„ä¸€ä¸ªå¯¹è±¡å‘é€æ¶ˆæ¯ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µåªæ˜¯ç¡®å®šäº†è¦å‘æ¥æ”¶è€…å‘é€è¿™æ¡æ¶ˆæ¯ï¼Œè€Œæ¥å—è€…å°†è¦å¦‚ä½•å“åº”å’Œå¤„ç†è¿™æ¡æ¶ˆæ¯ï¼Œé‚£å°±è¦çœ‹è¿è¡Œæ—¶æ¥å†³å®šäº†ã€‚</p>
<p><code>C</code>è¯­è¨€ä¸­ï¼Œåœ¨<strong>ç¼–è¯‘æœŸ</strong>ï¼Œå‡½æ•°çš„è°ƒç”¨å°±ä¼šå†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚<br>è€Œ<code>OC</code>çš„å‡½æ•°ï¼Œå±äºåŠ¨æ€è°ƒç”¨è¿‡ç¨‹ï¼Œåœ¨<strong>ç¼–è¯‘æœŸ</strong>å¹¶ä¸èƒ½å†³å®šçœŸæ­£è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œåªæœ‰åœ¨çœŸæ­£<strong>è¿è¡Œæ—¶</strong>æ‰ä¼šæ ¹æ®å‡½æ•°çš„åç§°æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°æ¥è°ƒç”¨ã€‚</p>
<p>åœ¨<code>Objective-C</code>ä¸­ï¼Œä½¿ç”¨<code>[receiver message]</code>è¯­æ³•å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œ<code>receiver</code>å¯¹è±¡çš„<code>message</code>æ–¹æ³•çš„ä»£ç ï¼Œè€Œæ˜¯å‘<code>receiver</code>å‘é€ä¸€æ¡<code>message</code>æ¶ˆæ¯ï¼Œè¿™æ¡æ¶ˆæ¯å¯èƒ½ç”±<code>receiver</code>æ¥å¤„ç†ï¼Œä¹Ÿå¯èƒ½ç”±è½¬å‘ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ï¼Œä¹Ÿæœ‰å¯èƒ½å‡è£…æ²¡æœ‰æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯è€Œæ²¡æœ‰å¤„ç†ã€‚å…¶å®<code>[receiver message]</code>è¢«ç¼–è¯‘å™¨è½¬åŒ–ä¸º:</p>
<p><code>id objc_msgSend ( id self, SEL op, ... );</code></p>
<h3 id="åè¯è§£é‡Š"><a href="#åè¯è§£é‡Š" class="headerlink" title="åè¯è§£é‡Š"></a>åè¯è§£é‡Š</h3><h4 id="NSObjectã€id"><a href="#NSObjectã€id" class="headerlink" title="NSObjectã€id"></a>NSObjectã€id</h4><p>æ¯å½“ä½ <code>coding</code>çš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰å‘ç°ä½ åˆ›å»ºçš„æ‰€æœ‰çš„ç±»åˆ°æœ€åéƒ½æ˜¯ä»¥<code>NSObject</code>ä¸ºåŸºç±»ï¼Œä¸ç›¸ä¿¡çš„è¯å°±æŒ‰ä½<code>command</code>é”®ï¼Œä¸€æ­¥ä¸€æ­¥çš„ç‚¹ï¼Œç‚¹åˆ°ä¸èƒ½ç‚¹ï¼ï¼ˆ<code>NSProxy</code>å‡ ä¸ªç‰¹æ®Šçš„é™¤å¤–ï¼‰ï¼Œç„¶åæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹<code>NSObject</code>ã€‚</p>
<p><code>Apple</code>ç»´æŠ¤çš„ä¸€ä»½è¿è¡Œæ—¶æºç : <a href="http://opensource.apple.com//source/objc4/objc4-680/" target="_blank"><font color="blue"><u>objc4-680</u></font></a></p>
<p>ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘æŠŠæºç éƒ½è´´åœ¨ä¸€èµ·äº†ï¼Œçœ‹å‡ ä¸ªç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br><span class="line"></span><br><span class="line">//objc_objectè¿™æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„idç±»å‹ï¼ŒæŒ‡å‘çš„ç±»å‹ä¸å±€é™äºNSObjectï¼Œè­¬å¦‚NSProxy</span><br><span class="line">typedef struct objc_object *id;</span><br><span class="line"></span><br><span class="line">//NSObject * å°±æ˜¯ NSObjectç±»å‹çš„æŒ‡é’ˆäº†ï¼Œå®ƒèŒƒå›´è¾ƒå°ã€‚</span><br><span class="line">@interface NSObject &lt;NSObject&gt; &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@interface Object &#123; </span><br><span class="line">    Class isa; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@interface NSObject &lt;NSObject&gt; &#123;</span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct objc_object &#123;</span><br><span class="line">private:</span><br><span class="line"></span><br><span class="line">	 //ä½ ä¼šå‘ç°isa_tæ˜¯ä¸ªunion</span><br><span class="line">    isa_t isa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct objc_class : objc_object &#123;</span><br><span class="line">    // Class ISA;</span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             // formerly cache pointer and vtable</span><br><span class="line">    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typedef struct objc_object &#123;</span><br><span class="line">    Class isa;</span><br><span class="line">&#125; *id;</span><br><span class="line"></span><br><span class="line">union isa_t </span><br><span class="line">&#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§<code>struct objc_class : objc_object</code> <code>objc_class</code>ç»§æ‰¿äº<code>objc_object</code></p>
<p><code>objc_class</code>å½“ç„¶ä¹Ÿä¼šåŒ…å«ç›¸åŒçš„<code>isa</code>ç»“æ„ä½“ï¼Œ<code>Class</code>æ˜¯<code>objc_class`</code> typedef<code>è¿‡æ¥çš„ï¼Œåˆæœ‰ç€ç»§æ‰¿å…³ç³»ã€‚æ‰€ä»¥</code>Class`æœ¬èº«ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ã€‚</p>
<p><code>objc_class</code>ä¸­å…¶ä»–æˆå‘˜ï¼šçœ‹åå­—ç†è§£ï¼Œçˆ¶ç±»<code>superclass</code>ï¼Œæ–¹æ³•ç¼“å­˜<code>cache</code>ï¼Œæœ€åä¸€ä¸ªä¸å®¹æ˜“çœ‹ï¼Œæˆ‘å…ˆè¯´ä¸‹æ˜¯å½“å‰ç±»çš„å®ä¾‹æ–¹æ³•çš„ä¸€ä¸ªé›†åˆã€‚</p>
<h4 id="isa"><a href="#isa" class="headerlink" title="isa"></a>isa</h4><p>å…ˆè¯´ <code>isa</code>è¡¨ç¤ºä¸€ä¸ª<code>Class</code>å¯¹è±¡çš„<code>Class</code>ï¼Œä¹Ÿå°±æ˜¯<code>Meta Class</code>ã€‚åœ¨é¢å‘å¯¹è±¡è®¾è®¡ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œ<code>Class</code>åœ¨è®¾è®¡ä¸­æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>å½“ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå°±æ˜¯é€šè¿‡<code>isa</code>æ‰¾åˆ°ç›¸åº”çš„ç±»ï¼Œç„¶ååœ¨è¯¥ç±»çš„<code>class_data_bits_t</code>ï¼ˆä¸Šæ–‡ä¸­<code>objc_class</code>çš„æˆå‘˜ï¼‰ä¸­å»æŸ¥æ‰¾æ–¹æ³•ã€‚<code>class_data_bits_t</code>æ˜¯æŒ‡å‘äº†ç±»å¯¹è±¡çš„æ•°æ®åŒºåŸŸã€‚åœ¨è¯¥æ•°æ®åŒºåŸŸå†…æŸ¥æ‰¾ç›¸åº”æ–¹æ³•çš„å¯¹åº”å®ç°ã€‚</p>
<p>å¦‚æœæ˜¯ç±»æ–¹æ³•å‘¢ï¼Ÿå½“ç„¶ä¹Ÿæ˜¯é€šè¿‡<code>isa</code>äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`å¯¹è±¡çš„å®ä¾‹æ–¹æ³•` â€”â€” &gt;  `isa` â€”â€” &gt; `å¯¹è±¡æ‰€å±ç±»`</span><br><span class="line"></span><br><span class="line">`ç±»æ–¹æ³•` â€”â€” &gt; `isa` â€”â€” &gt; `â“`</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¯´äº†ç±»ä¹Ÿæ˜¯ä¸ªå¯¹è±¡ã€‚é‚£å°±è®©<code>isa</code>åœ¨ç±»å¯¹è±¡æ‰€å±çš„ç±»ä¸­æ‰¾ã€‚æˆ‘ä»¬å«å®ƒçŒ¿ç±»ï¼Œä¸å¥½æ„æ€æ‰“é”™äº†ï¼Œå…ƒç±»<code>Meta Class</code>ã€‚</p>
<p>ä¸‹å›¾å¾ˆå¥½è§£é‡Šäº†å¯¹è±¡ï¼Œç±»ï¼Œå…ƒç±»ä¹‹é—´çš„å…³ç³»ã€‚ </p>
<p><img src="http://oma38gsun.bkt.clouddn.com/meta-class.jpg" alt=""></p>
<p>è§£é‡Šä¸€ä¸‹è¿™ä¸ªå›¾ï¼š å®çº¿æ˜¯<code>super_class</code>æŒ‡é’ˆï¼Œè™šçº¿æ˜¯<code>isa</code>æŒ‡é’ˆã€‚</p>
<ul>
<li><code>Root Class</code>æ˜¯<code>NSObject</code>ï¼Œ <code>NSObject</code>æ˜¯æ²¡æœ‰è¶…ç±»çš„ï¼Œæ‰€ä»¥<code>Root class(class)</code>çš„<code>superclass</code>æŒ‡å‘<code>nil</code>ã€‚</li>
<li>æ¯ä¸ª<code>Class</code>éƒ½æœ‰ä¸€ä¸ª<code>isa</code>æŒ‡é’ˆæŒ‡å‘å”¯ä¸€çš„<code>Meta class</code></li>
<li><code>Root class(meta)</code>çš„<code>superclass</code>æŒ‡å‘<code>Root class(class)</code>ï¼Œä¹Ÿå°±æ˜¯<code>NSObject</code>ï¼Œå½¢æˆä¸€ä¸ªå›è·¯ã€‚</li>
<li>æ¯ä¸ª<code>Meta class</code>çš„<code>isa</code>æŒ‡é’ˆéƒ½æŒ‡å‘<code>Root class (meta)</code>ã€‚</li>
</ul>
<p><code>isa</code>çš„ç±»å‹æ˜¯<code>isa_t</code>ã€‚ æºç <code>isa_t</code>æ˜¯ä¸ªè”åˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">union isa_t </span><br><span class="line">&#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å¯¹äº<code>isa_t</code>çš„æ·±å…¥äº†è§£ï¼Œæˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼æŠ±æ­‰å“ˆğŸ¶</strong></p>
<p>æ‡‚äº†ä¸Šå›¾å’Œå…ƒç±»çš„æ¦‚å¿µå°±å¯ä»¥äº†ã€‚</p>
<h4 id="éšè—å‚æ•°selfå’Œ-cmd"><a href="#éšè—å‚æ•°selfå’Œ-cmd" class="headerlink" title="éšè—å‚æ•°selfå’Œ_cmd"></a>éšè—å‚æ•°selfå’Œ_cmd</h4><p>å½“<code>[receiver message]</code>è°ƒç”¨æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿä¼šåœ¨è¿è¡Œæ—¶å·å·åœ°åŠ¨æ€ä¼ å…¥ä¸¤ä¸ªéšè—å‚æ•°<code>self</code>å’Œ<code>_cmd</code>ï¼Œä¹‹æ‰€ä»¥ç§°å®ƒä»¬ä¸ºéšè—å‚æ•°ï¼Œæ˜¯å› ä¸ºåœ¨æºä»£ç ä¸­æ²¡æœ‰å£°æ˜å’Œå®šä¹‰è¿™ä¸¤ä¸ªå‚æ•°ã€‚è‡³äºå¯¹äº<code>self</code>çš„æè¿°ï¼Œä¸Šé¢å·²ç»è§£é‡Šéå¸¸æ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹è®²è§£<code>_cmd</code>ã€‚</p>
<p><code>_cmd</code>è¡¨ç¤ºå½“å‰è°ƒç”¨æ–¹æ³•ï¼Œå…¶å®å®ƒå°±æ˜¯ä¸€ä¸ªæ–¹æ³•é€‰æ‹©å™¨<code>SEL</code>ï¼ˆ<em>ä¸‹æ–‡æåˆ°</em>ï¼‰ã€‚ä¸€èˆ¬ç”¨äºåˆ¤æ–­æ–¹æ³•åæˆ–åœ¨<code>Associated Objects</code>ä¸­å”¯ä¸€æ ‡è¯†é”®åï¼Œåé¢åœ¨<code>Associated Objects</code>ä¼šè®²åˆ°ã€‚</p>
<h4 id="self-å’Œ-super"><a href="#self-å’Œ-super" class="headerlink" title="self å’Œ super"></a>self å’Œ super</h4><p><code>self</code>è¡¨ç¤ºå½“å‰è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œè€Œ<code>super</code>æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ ‡ç¤ºç¬¦ï¼Œå’Œ<code>self</code>æŒ‡å‘åŒä¸€ä¸ªæ¶ˆæ¯æ¥å—è€…ã€‚</p>
<p>è­¬å¦‚<code>[self class]</code>å’Œ<code>[super class]</code>ï¼Œæ¥å—æ¶ˆæ¯è€…éƒ½æ˜¯å½“å‰è¿™ä¸ªç±»çš„å¯¹è±¡ï¼Œä½†<code>super</code>ä¸<code>self</code>ä¸åŒçš„æ˜¯ï¼Œ<code>self</code>è°ƒç”¨<code>class</code>æ–¹æ³•æ—¶ï¼Œæ˜¯åœ¨å­ç±»ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè€Œ<code>super</code>è°ƒç”¨<code>class</code>æ–¹æ³•æ—¶ï¼Œæ˜¯åœ¨çˆ¶ç±»ä¸­æŸ¥æ‰¾æ–¹æ³•ã€‚</p>
<p>åˆè­¬å¦‚å½“è°ƒç”¨<code>[self class]</code>æ–¹æ³•æ—¶ï¼Œä¼šè½¬åŒ–ä¸º<code>objc_msgSend</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><code>id objc_msgSend(id self, SEL op, ...)</code></p>
<p>è¿™æ—¶ä¼šä»å½“å‰ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åˆ°çˆ¶ç±»æŸ¥æ‰¾ï¼Œè¿˜æ˜¯æ²¡æœ‰ï¼Œæœ€ååœ¨<code>NSObject</code>ç±»æŸ¥æ‰¾åˆ°ã€‚æˆ‘ä»¬å¯ä»¥ä»<code>NSObject.m</code>æ–‡ä»¶ä¸­çœ‹åˆ°<code>- (Class)class</code>çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (Class)class &#123;</span><br><span class="line">    return object_getClass(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆè­¬å¦‚å½“è°ƒç”¨<code>[super class]</code>æ–¹æ³•æ—¶ï¼Œä¼šè½¬åŒ–ä¸º<code>objc_msgSendSuper</code>ï¼Œè¿™ä¸ªå‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><code>id objc_msgSendSuper(struct objc_super *super, SEL op, ...)</code></p>
<p><code>objc_msgSendSuper</code>å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°<code>super</code>çš„æ•°æ®ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_super</code>çš„ç»“æ„ä½“ï¼Œä»<code>message.h</code>æ–‡ä»¶ä¸­æŸ¥çœ‹å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/// Specifies the superclass of an instance. </span><br><span class="line">struct objc_super &#123;</span><br><span class="line">    /// Specifies an instance of a class.</span><br><span class="line">    __unsafe_unretained id receiver;</span><br><span class="line"></span><br><span class="line">    /// Specifies the particular superclass of the instance to message. </span><br><span class="line">#if !defined(__cplusplus)  &amp;&amp;  !__OBJC2__</span><br><span class="line">    /* For compatibility with old objc-runtime.h header */</span><br><span class="line">    __unsafe_unretained Class class;</span><br><span class="line">#else</span><br><span class="line">    __unsafe_unretained Class super_class;</span><br><span class="line">#endif</span><br><span class="line">    /* super_class is the first class to search */</span><br><span class="line">&#125;;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>ç»“æ„ä½“åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯<code>receiver</code>ï¼Œè¡¨ç¤ºæŸä¸ªç±»çš„å®ä¾‹ã€‚ç¬¬äºŒä¸ªæ˜¯<code>super_class</code>è¡¨ç¤ºå½“å‰ç±»çš„çˆ¶ç±»ã€‚</p>
<p>è¿™æ—¶é¦–å…ˆä¼šæ„é€ å‡º<code>objc_super</code>ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯<code>self</code>ï¼Œç¬¬äºŒä¸ªæˆå‘˜æ˜¯<code>(id)class_getSuperclass(objc_getClass(&quot;Class&quot;))</code>ï¼Œå®é™…ä¸Šè¯¥å‡½æ•°ä¼šè¾“å‡º<code>SuperClass</code>ã€‚ç„¶ååœ¨çˆ¶ç±»æŸ¥æ‰¾<code>class</code>æ–¹æ³•ï¼ŒæŸ¥æ‰¾ä¸åˆ°ï¼Œæœ€ååœ¨<code>NSObject</code>æŸ¥åˆ°ã€‚æ­¤æ—¶ï¼Œå†…éƒ¨ä½¿ç”¨<code>objc_msgSend(objc_super-&gt;receiver, @selector(class))</code>å»è°ƒç”¨ï¼Œä¸<code>[self class]</code>è°ƒç”¨ç›¸åŒï¼Œæ‰€ä»¥ç»“æœè¿˜æ˜¯å½“å‰ç±»ã€‚</p>
<h4 id="Ivar"><a href="#Ivar" class="headerlink" title="Ivar"></a>Ivar</h4><p><code>Ivar</code>è¡¨ç¤ºç±»ä¸­çš„å®ä¾‹å˜é‡ï¼Œåœ¨<code>runtime.h</code>æ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/// An opaque type that represents an instance variable.</span><br><span class="line">typedef struct objc_ivar *Ivar;</span><br><span class="line"></span><br><span class="line">struct objc_ivar &#123;</span><br><span class="line">    char *ivar_name                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    char *ivar_type                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    int ivar_offset                                          OBJC2_UNAVAILABLE;</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">    int space                                                OBJC2_UNAVAILABLE;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Ivar</code>å…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_ivar</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œå®ƒåŒ…å«äº†å˜é‡å<code>(ivar_name)</code>ã€å˜é‡ç±»å‹<code>(ivar_type)</code>ç­‰ä¿¡æ¯ã€‚</p>
<h4 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h4><p><code>SEL</code>ç§°æ–¹æ³•é€‰æ‹©å™¨</p>
<p>é€šä¿—è¯æ¥è®²ï¼Œ<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„ç±»çš„ç»“æ„ä½“ä¸­æœ‰è¿™æ ·ä¸€å¼ <code>SEL</code>å’Œ<code>IMP</code>å¯¹åº” çš„Dispatch tableã€‚ä½ æ‰¾åˆ°äº†SELï¼Œæœ€åè¿˜æ˜¯è¦é€šè¿‡è¿™ä¸ªtableæ‰¾åˆ°IMPã€‚<code>SEL</code>åªæ˜¯ä¸€ä¸ªæ–¹æ³•ç¼–å·ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„æ–¹æ³•å®ç°åœ°å€ã€‚</p>
<p><code>SEL</code>è¦è¯´çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœç±»ä¸åŒï¼Œä½†æ˜¯æœ‰ç›¸åŒçš„æ–¹æ³•ï¼Œä»–ä»¬å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„ï¼Œå³ä½¿å‚æ•°çš„ç±»å‹ä¸åŒï¼Œä»–ä»¬å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥<code>Objective-C</code>ä¸æ”¯æŒå‡½æ•°é‡è½½ï¼Œæœ‰å…³ä»€ä¹ˆæ˜¯å‡½æ•°é‡è½½å¯ä»¥äº†è§£ä¸‹<code>C++</code></p>
<p>æ¥å—è€…<code>receiver</code>æ”¶åˆ°å¯¹åº”çš„<code>selector</code>ï¼Œå¦‚æœæœ‰ä¸èƒ½æ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æƒ…å†µï¼Œè¿™æ¡<code>message</code>è¦è¢«è½¬å‘ï¼Œæˆ–è€…åˆ©ç”¨<code>runtime</code>åŠ¨æ€æ·»åŠ è¿™ä¸ªæ–¹æ³•çš„å®ç°æ¥æ­£å¸¸æ‰§è¡Œã€‚å¦‚æœæ­£å¸¸æ‰§è¡Œæˆ–è€…è½¬å‘éƒ½å¤±è´¥ã€‚ç¨‹åºä¼š<code>crash</code></p>
<p>æ‰€ä»¥<code>OC</code>è¿™é—¨è¿è¡Œæ—¶è¯­è¨€åœ¨<strong>ç¼–è¯‘æœŸ</strong>åªç¡®å®šäº†å‘æ¶ˆæ¯ï¼Œæ¥å—è€…å¦‚ä½•å“åº”æˆ–è€…å¤„ç†æ¶ˆæ¯æ˜¯åœ¨<strong>è¿è¡Œæ—¶</strong><code>runtime</code>å†³å®šï¼Œæ‰€ä»¥å’Œ<code>C</code>è¯­è¨€ä¸åŒï¼Œä¸å£°æ˜æ–¹æ³•ï¼Œç¨‹åºç¼–è¯‘ä¹Ÿä¸ä¼šæŠ¥é”™ã€‚</p>
<h4 id="IMP"><a href="#IMP" class="headerlink" title="IMP"></a>IMP</h4><p><code>IMP</code>æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘æ–¹æ³•çš„å®ç°ï¼Œåœ¨<code>objc.h</code>æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/// A pointer to the function of a method implementation. </span><br><span class="line">#if !OBJC_OLD_DISPATCH_PROTOTYPES</span><br><span class="line">typedef void (*IMP)(void /* id, SEL, ... */ ); </span><br><span class="line">#else</span><br><span class="line">typedef id (*IMP)(id, SEL, ...); </span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>å½“ä½ å‘æŸä¸ªå¯¹è±¡å‘é€ä¸€æ¡ä¿¡æ¯ï¼Œå¯ä»¥ç”±è¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ¥æŒ‡å®šæ–¹æ³•çš„å®ç°ï¼Œå®ƒæœ€ç»ˆå°±ä¼šæ‰§è¡Œé‚£æ®µä»£ç ï¼Œè¿™æ ·å¯ä»¥ç»•å¼€æ¶ˆæ¯ä¼ é€’é˜¶æ®µè€Œå»æ‰§è¡Œå¦ä¸€ä¸ªæ–¹æ³•å®ç°ã€‚</p>
<p>è¯´å¥å¤§ç™½è¯ï¼Œæ‹¿åˆ°äº†<code>IMP</code>ï¼Œæ‰èƒ½åƒä½¿ç”¨<code>C</code>è¯­è¨€å‡½æ•°æŒ‡é’ˆä¸€æ ·è‚†æ— å¿Œæƒ®ã€‚</p>
<h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><p><code>Method</code>è¡¨ç¤ºç±»ä¸­çš„æŸä¸ªæ–¹æ³•ï¼Œåœ¨runtime.hæ–‡ä»¶ä¸­æ‰¾åˆ°å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/// An opaque type that represents a method in a class definition.</span><br><span class="line">typedef struct objc_method *Method;</span><br><span class="line"></span><br><span class="line">struct objc_method &#123;</span><br><span class="line">    SEL method_name                                          OBJC2_UNAVAILABLE;</span><br><span class="line">    char *method_types                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    IMP method_imp                                           OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®<code>Method</code>å°±æ˜¯ä¸€ä¸ªæŒ‡å‘<code>objc_method</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œå®ƒå­˜å‚¨äº†æ–¹æ³•å<code>(method_name)</code>ã€æ–¹æ³•ç±»å‹<code>(method_types)</code>å’Œæ–¹æ³•å®ç°<code>(method_imp)</code>ç­‰ä¿¡æ¯ã€‚</p>
<p>å¤§ç™½è¯å°±æ˜¯ï¼š<code>Method</code>è¡¨ç¤ºä¸€ç§ç±»å‹ï¼Œè¿™ç§ç±»å‹ä¸<code>SEL</code>å’Œå®ç°<code>IMP</code>ç›¸å…³ã€‚</p>
<h4 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h4><p><code>Cache</code>ä¸»è¦ç”¨æ¥ç¼“å­˜ï¼Œé‚£å®ƒç¼“å­˜ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å…ˆåœ¨<code>runtime.h</code>æ–‡ä»¶çœ‹çœ‹å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_cache *Cache                             OBJC2_UNAVAILABLE;</span><br><span class="line"></span><br><span class="line">struct objc_cache &#123;</span><br><span class="line">    unsigned int mask /* total = mask + 1 */                 OBJC2_UNAVAILABLE;</span><br><span class="line">    unsigned int occupied                                    OBJC2_UNAVAILABLE;</span><br><span class="line">    Method buckets[1]                                        OBJC2_UNAVAILABLE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>Cache</code>å…¶å®å°±æ˜¯ä¸€ä¸ªå­˜å‚¨<code>Method</code>çš„é“¾è¡¨ï¼Œä¸»è¦æ˜¯ä¸ºäº†ä¼˜åŒ–æ–¹æ³•è°ƒç”¨çš„æ€§èƒ½ã€‚å½“å¯¹è±¡<code>receiver</code>è°ƒç”¨æ–¹æ³•<code>message</code>æ—¶ï¼Œé¦–å…ˆæ ¹æ®å¯¹è±¡<code>receiver</code>çš„isaæŒ‡é’ˆæŸ¥æ‰¾åˆ°å®ƒå¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨ç±»çš„<code>methodLists</code>ä¸­æœç´¢æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ä½¿ç”¨<code>super_class</code>æŒ‡é’ˆåˆ°çˆ¶ç±»ä¸­çš„<code>methodLists</code>æŸ¥æ‰¾ï¼Œä¸€æ—¦æ‰¾åˆ°å°±è°ƒç”¨æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæœ‰å¯èƒ½æ¶ˆæ¯è½¬å‘ï¼Œä¹Ÿå¯èƒ½å¿½ç•¥å®ƒã€‚ä½†è¿™æ ·æŸ¥æ‰¾æ–¹å¼æ•ˆç‡å¤ªä½ï¼Œå› ä¸ºå¾€å¾€ä¸€ä¸ªç±»å¤§æ¦‚åªæœ‰20%çš„æ–¹æ³•ç»å¸¸è¢«è°ƒç”¨ï¼Œå æ€»è°ƒç”¨æ¬¡æ•°çš„80%ã€‚æ‰€ä»¥ä½¿ç”¨<code>Cache</code>æ¥ç¼“å­˜ç»å¸¸è°ƒç”¨çš„æ–¹æ³•ï¼Œå½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œä¼˜å…ˆåœ¨CacheæŸ¥æ‰¾ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†åˆ°<code>methodLists</code>æŸ¥æ‰¾ã€‚</p>
<p>å…³äº <code>SEL</code>, <code>IMP</code>, <code>Method</code>çš„ç†è§£ï¼Œç†è§£çš„ä¸å¥½çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« <a href="http://blog.csdn.net/fengsh998/article/details/8614486" target="_blank" rel="noopener">http://blog.csdn.net/fengsh998/article/details/8614486</a></p>
<h3 id="RuntimeåŸç†"><a href="#RuntimeåŸç†" class="headerlink" title="RuntimeåŸç†"></a>RuntimeåŸç†</h3><h4 id="objc-msgSendå‡½æ•°æ˜¯å¦‚ä½•å‘é€æ¶ˆæ¯çš„"><a href="#objc-msgSendå‡½æ•°æ˜¯å¦‚ä½•å‘é€æ¶ˆæ¯çš„" class="headerlink" title="objc_msgSendå‡½æ•°æ˜¯å¦‚ä½•å‘é€æ¶ˆæ¯çš„"></a>objc_msgSendå‡½æ•°æ˜¯å¦‚ä½•å‘é€æ¶ˆæ¯çš„</h4><ul>
<li>é¦–å…ˆæ ¹æ®<code>receiver</code>å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆè·å–å®ƒå¯¹åº”çš„<code>class</code></li>
<li>ä¼˜å…ˆåœ¨<code>class</code>çš„<code>cache</code>æŸ¥æ‰¾<code>messageæ–¹</code>æ³•ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå†åˆ°<code>methodLists</code>æŸ¥æ‰¾</li>
<li>å¦‚æœæ²¡æœ‰åœ¨<code>class</code>æ‰¾åˆ°ï¼Œå†åˆ°<code>super_class</code>æŸ¥æ‰¾</li>
<li>ä¸€æ—¦æ‰¾åˆ°<code>message</code>è¿™ä¸ªæ–¹æ³•ï¼Œå°±æ‰§è¡Œå®ƒå®ç°çš„<code>IMP</code>ã€‚ç¼“å­˜åˆ°<code>cache</code>é‡Œé¢ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨</li>
</ul>
<h4 id="æ¶ˆæ¯å‘é€å’Œè½¬å‘"><a href="#æ¶ˆæ¯å‘é€å’Œè½¬å‘" class="headerlink" title="æ¶ˆæ¯å‘é€å’Œè½¬å‘"></a>æ¶ˆæ¯å‘é€å’Œè½¬å‘</h4><p><code>[receiver message]</code>è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¦‚æœåœ¨<code>message</code>æ–¹æ³•åœ¨<code>receiver</code>å¯¹è±¡çš„ç±»ç»§æ‰¿ä½“ç³»ä¸­æ²¡æœ‰æ‰¾åˆ°æ–¹æ³•ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¨‹åºåœ¨è¿è¡Œæ—¶å°±ä¼šCrashæ‰ï¼ŒæŠ›å‡º <code>unrecognized selector sent to â€¦</code>ç±»ä¼¼è¿™æ ·çš„å¼‚å¸¸ä¿¡æ¯ã€‚ä½†åœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œè¿˜æœ‰ä¸‰æ¬¡æœºä¼šæŒ‰ä»¥ä¸‹é¡ºåºè®©ä½ æ‹¯æ•‘ç¨‹åºã€‚</p>
<h5 id="Method-Resolution"><a href="#Method-Resolution" class="headerlink" title="Method Resolution"></a>Method Resolution</h5><p>é¦–å…ˆ<code>OC</code>åœ¨è¿è¡Œæ—¶è°ƒç”¨<code>+ resolveInstanceMethod:</code>æˆ–<code>+ resolveClassMethod:</code>æ–¹æ³•ï¼Œè®©ä½ æ·»åŠ æ–¹æ³•çš„å®ç°ã€‚å¦‚æœä½ æ·»åŠ æ–¹æ³•å¹¶è¿”å›YESï¼Œé‚£ç³»ç»Ÿåœ¨è¿è¡Œæ—¶å°±ä¼šé‡æ–°å¯åŠ¨ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@interface Message : NSObject</span><br><span class="line"></span><br><span class="line">- (void)sendMessage:(NSString *)word;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@implementation Message</span><br><span class="line"></span><br><span class="line">- (void)sendMessage:(NSString *)word</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;normal way : send message = %@&quot;, word);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘åœ¨<code>viewDidLoad</code>æ–¹æ³•ä¸­åˆ›å»º<code>Message</code>å¯¹è±¡å¹¶è°ƒç”¨<code>sendMessage</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Message *message = [Message new];</span><br><span class="line">    [message sendMessage:@&quot;SwifterFit&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼šsend message = SwifterFit</p>
<p>ä½†ç°åœ¨æˆ‘å°†åŸæ¥<code>sendMessage</code>æ–¹æ³•å®ç°ç»™æ³¨é‡Šæ‰ï¼Œè¦†ç›–<code>resolveInstanceMethod</code>æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Method Resolution</span><br><span class="line"></span><br><span class="line">/// override resolveInstanceMethod or resolveClassMethod for changing sendMessage method implementation</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">    if (sel == @selector(sendMessage:)) &#123;</span><br><span class="line">        class_addMethod([self class], sel, imp_implementationWithBlock(^(id self, NSString *word) &#123;</span><br><span class="line">            NSLog(@&quot;method resolution way : send message = %@&quot;, word);</span><br><span class="line">        &#125;), &quot;v@*&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼šsend message = SwifterFit</p>
<p>å¦‚æœ<code>resolveInstanceMethod</code>æ–¹æ³•è¿”å›<code>NO</code>ï¼Œè¿è¡Œæ—¶å°±è·³è½¬åˆ°ä¸‹ä¸€æ­¥ï¼šæ¶ˆæ¯è½¬å‘<code>Message Forwarding</code></p>
<h5 id="Fast-Forwarding"><a href="#Fast-Forwarding" class="headerlink" title="Fast Forwarding"></a>Fast Forwarding</h5><p>å¦‚æœç›®æ ‡å¯¹è±¡å®ç°<code>- forwardingTargetForSelector:</code>æ–¹æ³•ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡Œæ—¶è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåªè¦è¿™ä¸ªæ–¹æ³•è¿”å›çš„ä¸æ˜¯<code>nil</code>æˆ–<code>self</code>ï¼Œä¹Ÿä¼šé‡å¯æ¶ˆæ¯å‘é€çš„è¿‡ç¨‹ï¼ŒæŠŠè¿™æ¶ˆæ¯è½¬å‘ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ã€‚å¦åˆ™ï¼Œå°±ä¼šç»§ç»­<code>Normal Fowarding</code>ã€‚</p>
<p>ç»§ç»­ä¸Šé¢<code>Message</code>ç±»çš„ä¾‹å­ï¼Œå°†<code>sendMessage</code>å’Œ<code>resolveInstanceMethod</code>æ–¹æ³•æ³¨é‡Šæ‰ï¼Œç„¶åæ·»åŠ <code>forwardingTargetForSelector</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<p>å°†<code>sendMessage</code>å’Œ<code>resolveInstanceMethod</code>æ–¹æ³•æ³¨é‡Šæ‰ï¼Œç„¶åæ·»åŠ <code>forwardingTargetForSelector</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Fast Forwarding</span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    if (aSelector == @selector(sendMessage:)) &#123;</span><br><span class="line">        return [MessageForwarding new];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶è¿˜ç¼ºä¸€ä¸ªè½¬å‘æ¶ˆæ¯çš„ç±»<code>MessageForwarding</code>ï¼Œè¿™ä¸ªç±»çš„è®¾è®¡ä¸å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@interface MessageForwarding : NSObject</span><br><span class="line"></span><br><span class="line">- (void)sendMessage:(NSString *)word;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@implementation MessageForwarding</span><br><span class="line"></span><br><span class="line">- (void)sendMessage:(NSString *)word</span><br><span class="line">&#123;</span><br><span class="line">    NSLog(@&quot;fast forwarding way : send message = %@&quot;, word);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå«<code>Fast</code>ï¼Œæ˜¯å› ä¸ºè¿™ä¸€æ­¥ä¸ä¼šåˆ›å»º<code>NSInvocation</code>å¯¹è±¡ï¼Œä½†<code>Normal Forwarding</code>ä¼šåˆ›å»ºå®ƒï¼Œæ‰€ä»¥ç›¸å¯¹äºæ›´å¿«ç‚¹ã€‚</p>
<h5 id="Normal-Forwarding"><a href="#Normal-Forwarding" class="headerlink" title="Normal Forwarding"></a>Normal Forwarding</h5><p>å¦‚æœæ²¡æœ‰ä½¿ç”¨<code>Fast Forwarding</code>æ¥æ¶ˆæ¯è½¬å‘ï¼Œæœ€ååªæœ‰ä½¿ç”¨<code>Normal Forwarding</code>æ¥è¿›è¡Œæ¶ˆæ¯è½¬å‘ã€‚å®ƒé¦–å…ˆè°ƒç”¨<code>methodSignatureForSelector:</code>æ–¹æ³•æ¥è·å–å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œå¦‚æœè¿”å›ä¸º<code>nil</code>ï¼Œç¨‹åºä¼šCrashæ‰ï¼Œå¹¶æŠ›å‡º<code>unrecognized selector sent to instance</code>å¼‚å¸¸ä¿¡æ¯ã€‚å¦‚æœè¿”å›ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œç³»ç»Ÿå°±ä¼šåˆ›å»ºä¸€ä¸ª<code>NSInvocation</code>å¯¹è±¡å¹¶è°ƒç”¨<code>-forwardInvocation:</code>æ–¹æ³•ã€‚</p>
<p>ç»§ç»­å‰é¢çš„ä¾‹å­ï¼Œå°†<code>forwardingTargetForSelector</code>æ–¹æ³•æ³¨é‡Šæ‰ï¼Œæ·»åŠ <code>methodSignatureForSelectorå’ŒforwardInvocation</code>æ–¹æ³•çš„å®ç°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Normal Forwarding</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">    NSMethodSignature *methodSignature = [super methodSignatureForSelector:aSelector];</span><br><span class="line"></span><br><span class="line">    if (!methodSignature) &#123;</span><br><span class="line">        methodSignature = [NSMethodSignature signatureWithObjCTypes:&quot;v@:*&quot;];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return methodSignature;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">    MessageForwarding *messageForwarding = [MessageForwarding new];</span><br><span class="line"></span><br><span class="line">    if ([messageForwarding respondsToSelector:anInvocation.selector]) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:messageForwarding];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Runtimeæä¾›ä¸‰ç§æ–¹å¼æ¥å°†åŸæ¥çš„æ–¹æ³•å®ç°ä»£æ›¿æ‰ï¼Œé‚£è¯¥æ€æ ·é€‰æ‹©å®ƒä»¬å‘¢ï¼Ÿ</p>
<ul>
<li><code>Method Resolution</code>ï¼šç”±äº<code>Method Resolution</code>ä¸èƒ½åƒæ¶ˆæ¯è½¬å‘é‚£æ ·å¯ä»¥äº¤ç»™å…¶ä»–å¯¹è±¡æ¥å¤„ç†ï¼Œæ‰€ä»¥åªé€‚ç”¨äºåœ¨åŸæ¥çš„ç±»ä¸­ä»£æ›¿æ‰ã€‚</li>
<li><code>Fast Forwarding</code>ï¼šå®ƒå¯ä»¥å°†æ¶ˆæ¯å¤„ç†è½¬å‘ç»™å…¶ä»–å¯¹è±¡ï¼Œä½¿ç”¨èŒƒå›´æ›´å¹¿ï¼Œä¸åªæ˜¯é™äºåŸæ¥çš„å¯¹è±¡ã€‚</li>
<li><code>Normal Forwarding</code>ï¼šå®ƒè·Ÿ<code>Fast Forwarding</code>ä¸€æ ·å¯ä»¥æ¶ˆæ¯è½¬å‘ï¼Œä½†å®ƒèƒ½é€šè¿‡<code>NSInvocation</code>å¯¹è±¡è·å–æ›´å¤šæ¶ˆæ¯å‘é€çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š<code>target</code>ã€<code>selector</code>ã€<code>arguments</code>å’Œè¿”å›å€¼ç­‰ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="Runtimeåº”ç”¨"><a href="#Runtimeåº”ç”¨" class="headerlink" title="Runtimeåº”ç”¨"></a>Runtimeåº”ç”¨</h3><h4 id="ä¸ºCategoryæ·»åŠ å±æ€§property"><a href="#ä¸ºCategoryæ·»åŠ å±æ€§property" class="headerlink" title="ä¸ºCategoryæ·»åŠ å±æ€§property"></a>ä¸ºCategoryæ·»åŠ å±æ€§property</h4><ul>
<li><code>Associated Objects</code></li>
</ul>
<p>å½“æƒ³ä½¿ç”¨<code>Category</code>å¯¹å·²å­˜åœ¨çš„ç±»è¿›è¡Œæ‰©å±•æ—¶ï¼Œä¸€èˆ¬åªèƒ½æ·»åŠ å®ä¾‹æ–¹æ³•æˆ–ç±»æ–¹æ³•ï¼Œè€Œä¸é€‚åˆæ·»åŠ é¢å¤–çš„å±æ€§ã€‚è™½ç„¶å¯ä»¥åœ¨<code>Category</code>å¤´æ–‡ä»¶ä¸­å£°æ˜<code>property</code>å±æ€§ï¼Œä½†åœ¨å®ç°æ–‡ä»¶ä¸­ç¼–è¯‘å™¨æ˜¯æ— æ³•<code>synthesize</code>ä»»ä½•å®ä¾‹å˜é‡å’Œå±æ€§è®¿é—®æ–¹æ³•ã€‚è¿™æ—¶éœ€è¦è‡ªå®šä¹‰å±æ€§è®¿é—®æ–¹æ³•å¹¶ä¸”ä½¿ç”¨<code>Associated Objects</code>æ¥ç»™å·²å­˜åœ¨çš„ç±»<code>Category</code>æ·»åŠ è‡ªå®šä¹‰çš„å±æ€§ã€‚<code>Associated Objects</code>æä¾›ä¸‰ä¸ªAPIæ¥å‘å¯¹è±¡æ·»åŠ ã€è·å–å’Œåˆ é™¤å…³è”å€¼ï¼š</p>
<p><code>void objc_setAssociatedObject (id object, const void *key, id value, objc_AssociationPolicy policy )</code><br><code>id objc_getAssociatedObject (id object, const void *key )</code><br><code>void objc_removeAssociatedObjects (id object )</code></p>
<p>å…¶ä¸­<code>objc_AssociationPolicy</code>æ˜¯ä¸ªæšä¸¾ç±»å‹ï¼Œå®ƒå¯ä»¥æŒ‡å®šObjcå†…å­˜ç®¡ç†çš„å¼•ç”¨è®¡æ•°æœºåˆ¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">typedef OBJC_ENUM(uintptr_t, objc_AssociationPolicy) &#123;</span><br><span class="line">    OBJC_ASSOCIATION_ASSIGN = 0,           /**&lt; Specifies a weak reference to the associated object. */</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = 1, /**&lt; Specifies a strong reference to the associated object. </span><br><span class="line">                                            *   The association is not made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = 3,   /**&lt; Specifies that the associated object is copied. </span><br><span class="line">                                            *   The association is not made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_RETAIN = 01401,       /**&lt; Specifies a strong reference to the associated object.</span><br><span class="line">                                            *   The association is made atomically. */</span><br><span class="line">    OBJC_ASSOCIATION_COPY = 01403          /**&lt; Specifies that the associated object is copied.</span><br><span class="line">                                            *   The association is made atomically. */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æœ‰ä¸ªå…³äº<code>NSObject+AssociatedObject</code> Categoryæ·»åŠ å±æ€§<code>associatedObject</code>çš„ç¤ºä¾‹ä»£ç :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (AssociatedObject)</span><br><span class="line"></span><br><span class="line">@property (strong, nonatomic) id associatedObject;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSObject (AssociatedObject)</span><br><span class="line"></span><br><span class="line">- (void)setAssociatedObject:(id)associatedObject</span><br><span class="line">&#123;</span><br><span class="line">    objc_setAssociatedObject(self, @selector(associatedObject), associatedObject, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)associatedObject</span><br><span class="line">&#123;</span><br><span class="line">    return objc_getAssociatedObject(self, _cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><code>Associated Objects</code>çš„keyè¦æ±‚æ˜¯å”¯ä¸€å¹¶ä¸”æ˜¯å¸¸é‡ï¼Œè€Œ<code>SEL</code>æ˜¯æ»¡è¶³è¿™ä¸ªè¦æ±‚çš„ï¼Œæ‰€ä»¥ä¸Šé¢çš„é‡‡ç”¨éšè—å‚æ•°<code>_cmd</code>ä½œä¸ºkeyã€‚</p>
<h4 id="Method-Swizzling"><a href="#Method-Swizzling" class="headerlink" title="Method Swizzling"></a>Method Swizzling</h4><p>æåˆ°<code>Objective-C</code> ä¸­çš„ <code>Runtime</code>ï¼Œå¤§å¤šæ•°äººç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯é»‘é­”æ³•<code>Method Swizzling</code>ã€‚æ¯•ç«Ÿè¿™æ˜¯<code>Runtime</code>é‡Œé¢å¾ˆå¼ºå¤§çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¯ä»¥é€šè¿‡<code>Runtime</code>çš„APIå®ç°æ›´æ”¹ä»»æ„çš„æ–¹æ³•ï¼Œç†è®ºä¸Šå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ç±»å/æ–¹æ³•å<code>hook</code>åˆ°ä»»ä½• <code>OC</code>æ–¹æ³•ï¼Œæ›¿æ¢ä»»ä½•ç±»çš„å®ç°ä»¥åŠæ–°å¢ä»»æ„ç±»ã€‚</p>
<p>ä¸¾çš„æœ€å¤šçš„ä¾‹å­åº”è¯¥å°±æ˜¯åŸ‹ç‚¹ç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯çš„ä¾‹å­ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬éœ€è¦åœ¨é¡µé¢ä¸Šä¸åŒçš„åœ°æ–¹ç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯ï¼Œå¸¸è§åšæ³•æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>å‚»ç“œå¼çš„åœ¨æ‰€æœ‰éœ€è¦ç»Ÿè®¡çš„é¡µé¢éƒ½åŠ ä¸Šä»£ç ã€‚è¿™æ ·åšç®€å•ï¼Œä½†æ˜¯é‡å¤çš„ä»£ç å¤ªå¤šã€‚</li>
<li>æŠŠç»Ÿè®¡çš„ä»£ç å†™å…¥åŸºç±»ä¸­ï¼Œæ¯”å¦‚è¯´<code>BaseViewController</code>ã€‚è¿™æ ·è™½ç„¶ä»£ç åªéœ€è¦å†™ä¸€æ¬¡ï¼Œä½†æ˜¯<code>UITableViewController</code>ï¼Œ<code>UICollectionViewcontroller</code>éƒ½éœ€è¦å†™ä¸€éï¼Œè¿™æ ·é‡å¤çš„ä»£ç ä¾æ—§ä¸å°‘ã€‚</li>
</ul>
<p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ <code>Method Swizzling</code>ã€‚</p>
<p><code>Method Swizzing</code>æ˜¯å‘ç”Ÿåœ¨<strong>è¿è¡Œæ—¶</strong>çš„ï¼Œä¸»è¦ç”¨äºåœ¨<strong>è¿è¡Œæ—¶</strong>å°†ä¸¤ä¸ª<code>Method</code>è¿›è¡Œäº¤æ¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>Method Swizzling</code>ä»£ç å†™åˆ°ä»»ä½•åœ°æ–¹ï¼Œä½†æ˜¯åªæœ‰åœ¨è¿™æ®µ<code>Method Swilzzling</code>ä»£ç æ‰§è¡Œå®Œæ¯•ä¹‹åäº’æ¢æ‰èµ·ä½œç”¨ã€‚è€Œä¸”<code>Method Swizzling</code>ä¹Ÿæ˜¯<code>iOS</code>ä¸­<code>AOP</code>(Aspect-Oriented Programming)(<em>é¢ç›¸æ–¹é¢ç¼–ç¨‹</em>)çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è‹¹æœè¿™ä¸€ç‰¹æ€§æ¥å®ç°<code>AOP</code>ç¼–ç¨‹ã€‚</p>
<p><code>Method Swizzling</code>æœ¬è´¨ä¸Šå°±æ˜¯å¯¹<code>IMP</code>å’Œ<code>SEL</code>è¿›è¡Œäº¤æ¢ã€‚</p>
<p>ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨éƒ½æ˜¯æ–°å»ºä¸€ä¸ªåˆ†ç±»ï¼Œåœ¨åˆ†ç±»ä¸­è¿›è¡Œ<code>Method Swizzling</code>æ–¹æ³•çš„äº¤æ¢ã€‚äº¤æ¢çš„ä»£ç æ¨¡æ¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">@implementation UIViewController (Swizzling)</span><br><span class="line">+ (void)load &#123;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        Class class = [self class];</span><br><span class="line">        // When swizzling a class method, use the following:</span><br><span class="line">        // Class class = object_getClass((id)self);</span><br><span class="line">        SEL originalSelector = @selector(viewWillAppear:);</span><br><span class="line">        SEL swizzledSelector = @selector(xxx_viewWillAppear:);</span><br><span class="line">        Method originalMethod = class_getInstanceMethod(class, originalSelector);</span><br><span class="line">        Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</span><br><span class="line">        BOOL didAddMethod = class_addMethod(class,</span><br><span class="line">                                            originalSelector,</span><br><span class="line">                                            method_getImplementation(swizzledMethod),</span><br><span class="line">                                            method_getTypeEncoding(swizzledMethod));</span><br><span class="line">        if (didAddMethod) &#123;</span><br><span class="line">            class_replaceMethod(class,</span><br><span class="line">                                swizzledSelector,</span><br><span class="line">                                method_getImplementation(originalMethod),</span><br><span class="line">                                method_getTypeEncoding(originalMethod));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">#pragma mark - Method Swizzling</span><br><span class="line">- (void)xxx_viewWillAppear:(BOOL)animated &#123;</span><br><span class="line">    [self xxx_viewWillAppear:animated];</span><br><span class="line">    NSLog(@&quot;viewWillAppear: %@&quot;, self);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><code>Method Swizzling</code>å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ä¿®æ”¹ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­<code>selector</code>å¯¹åº”çš„å‡½æ•°æˆ–è€…è®¾ç½®äº¤æ¢æ–¹æ³•å®ç°ï¼Œæ¥åŠ¨æ€ä¿®æ”¹æ–¹æ³•ã€‚å¯ä»¥é‡å†™æŸä¸ªæ–¹æ³•è€Œä¸ç”¨ç»§æ‰¿ï¼ŒåŒæ—¶è¿˜å¯ä»¥è°ƒç”¨åŸå…ˆçš„å®ç°ã€‚æ‰€ä»¥é€šå¸¸åº”ç”¨äºåœ¨<code>category</code>ä¸­æ·»åŠ ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<h4 id="æ³¨æ„ç‚¹"><a href="#æ³¨æ„ç‚¹" class="headerlink" title="æ³¨æ„ç‚¹"></a>æ³¨æ„ç‚¹</h4><h5 id="Swizzlingåº”è¯¥æ€»åœ¨-loadä¸­æ‰§è¡Œ"><a href="#Swizzlingåº”è¯¥æ€»åœ¨-loadä¸­æ‰§è¡Œ" class="headerlink" title="Swizzlingåº”è¯¥æ€»åœ¨+loadä¸­æ‰§è¡Œ"></a><code>Swizzling</code>åº”è¯¥æ€»åœ¨<code>+load</code>ä¸­æ‰§è¡Œ</h5><p><code>Objective-C</code>åœ¨è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ç±»çš„ä¸¤ä¸ªæ–¹æ³•<code>+load</code>å’Œ<code>+initialize</code>ã€‚<code>+load</code>ä¼šåœ¨ç±»åˆå§‹åŠ è½½æ—¶è°ƒç”¨ï¼Œ <code>+initialize</code>æ–¹æ³•æ˜¯ä»¥æ‡’åŠ è½½çš„æ–¹å¼è¢«è°ƒç”¨çš„ï¼Œå¦‚æœç¨‹åºä¸€ç›´æ²¡æœ‰ç»™æŸä¸ªç±»æˆ–å®ƒçš„å­ç±»å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»çš„ <code>+initialize</code>æ–¹æ³•æ˜¯æ°¸è¿œä¸ä¼šè¢«è°ƒç”¨çš„ã€‚æ‰€ä»¥<code>Swizzling</code>è¦æ˜¯å†™åœ¨<code>+initialize</code>æ–¹æ³•ä¸­ï¼Œæ˜¯æœ‰å¯èƒ½æ°¸è¿œéƒ½ä¸è¢«æ‰§è¡Œã€‚</p>
<p>å’Œ<code>+initialize</code>æ¯”è¾ƒ<code>+load</code>èƒ½ä¿è¯åœ¨ç±»çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­è¢«åŠ è½½ã€‚</p>
<h5 id="Swizzlingåº”è¯¥æ€»æ˜¯åœ¨dispatch-onceä¸­æ‰§è¡Œ"><a href="#Swizzlingåº”è¯¥æ€»æ˜¯åœ¨dispatch-onceä¸­æ‰§è¡Œ" class="headerlink" title="Swizzlingåº”è¯¥æ€»æ˜¯åœ¨dispatch_onceä¸­æ‰§è¡Œ"></a><code>Swizzling</code>åº”è¯¥æ€»æ˜¯åœ¨<code>dispatch_once</code>ä¸­æ‰§è¡Œ</h5><p>Swizzlingä¼šæ”¹å˜å…¨å±€çŠ¶æ€ï¼Œæ‰€ä»¥åœ¨è¿è¡Œæ—¶é‡‡å–ä¸€äº›é¢„é˜²æªæ–½ï¼Œä½¿ç”¨<code>dispatch_once</code>å°±èƒ½å¤Ÿç¡®ä¿ä»£ç ä¸ç®¡æœ‰å¤šå°‘çº¿ç¨‹éƒ½åªè¢«æ‰§è¡Œä¸€æ¬¡ã€‚è¿™å°†æˆä¸º<code>Method Swizzling</code>çš„æœ€ä½³å®è·µã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œé‚£å°±æ˜¯ç»§æ‰¿ä¸­ç”¨äº†<code>Swizzling</code>ã€‚å¦‚æœä¸å†™<code>dispatch_once</code>å°±ä¼šå¯¼è‡´<code>Swizzling</code>å¤±æ•ˆï¼</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚åŒæ—¶å¯¹<code>NSArray</code>å’Œ<code>NSMutableArray</code>ä¸­çš„<code>objectAtIndex:</code>æ–¹æ³•éƒ½è¿›è¡Œäº†<code>Swizzling</code>ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´<code>NSArray</code>ä¸­çš„<code>Swizzling</code>å¤±æ•ˆçš„ã€‚</p>
<p>å¯æ˜¯ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ</p>
<p>åŸå› æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰ç”¨<code>dispatch_once</code>æ§åˆ¶<code>Swizzling</code>åªæ‰§è¡Œä¸€æ¬¡ã€‚å¦‚æœè¿™æ®µ<code>Swizzling</code>è¢«æ‰§è¡Œå¤šæ¬¡ï¼Œç»è¿‡å¤šæ¬¡çš„äº¤æ¢<code>IMP</code>å’Œ<code>SEL</code>ä¹‹åï¼Œç»“æœå¯èƒ½å°±æ˜¯æœªäº¤æ¢ä¹‹å‰çš„çŠ¶æ€ã€‚</p>
<p>æ¯”å¦‚è¯´çˆ¶ç±»Açš„Bæ–¹æ³•å’Œå­ç±»Cçš„Dæ–¹æ³•è¿›è¡Œäº¤æ¢ï¼Œäº¤æ¢ä¸€æ¬¡åï¼Œçˆ¶ç±»AæŒæœ‰Dæ–¹æ³•çš„<code>IMP</code>ï¼Œå­ç±»CæŒæœ‰Bæ–¹æ³•çš„<code>IMP</code>ï¼Œä½†æ˜¯å†æ¬¡äº¤æ¢ä¸€æ¬¡ï¼Œå°±åˆè¿˜åŸäº†ã€‚çˆ¶ç±»Aè¿˜æ˜¯æŒæœ‰Bæ–¹æ³•çš„<code>IMP</code>ï¼Œå­ç±»Cè¿˜æ˜¯æŒæœ‰Dæ–¹æ³•çš„<code>IMP</code>ï¼Œè¿™æ ·å°±ç›¸å½“äºå’©æœ‰äº¤æ¢ã€‚å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœä¸å†™<code>dispatch_once</code>ï¼Œå¶æ•°æ¬¡äº¤æ¢ä»¥åï¼Œç›¸å½“äºæ²¡æœ‰äº¤æ¢ï¼Œ<code>Swizzling</code>å¤±æ•ˆï¼</p>
<h5 id="Swizzlingåœ¨-loadä¸­æ‰§è¡Œæ—¶ï¼Œä¸è¦è°ƒç”¨-super-load"><a href="#Swizzlingåœ¨-loadä¸­æ‰§è¡Œæ—¶ï¼Œä¸è¦è°ƒç”¨-super-load" class="headerlink" title="Swizzlingåœ¨+loadä¸­æ‰§è¡Œæ—¶ï¼Œä¸è¦è°ƒç”¨[super load]"></a><code>Swizzling</code>åœ¨<code>+load</code>ä¸­æ‰§è¡Œæ—¶ï¼Œä¸è¦è°ƒç”¨<code>[super load]</code></h5><p>åŸå› åŒæ³¨æ„ç‚¹äºŒï¼Œå¦‚æœæ˜¯å¤šç»§æ‰¿ï¼Œå¹¶ä¸”å¯¹åŒä¸€ä¸ªæ–¹æ³•éƒ½è¿›è¡Œäº†<code>Swizzling</code>ï¼Œé‚£ä¹ˆè°ƒç”¨<code>[super load]</code>ä»¥åï¼Œçˆ¶ç±»çš„<code>Swizzling</code>å°±å¤±æ•ˆäº†ã€‚</p>
<p>ç°åœ¨æ¯”è¾ƒç«çš„<code>hotfix</code>ï¼Œ<code>JSPatch</code>å°±æ˜¯åº”ç”¨äº†<code>OC</code>çš„<code>runtime</code>ç‰¹æ€§å®ç°<code>js</code>ä¸<code>OC</code>äº’é€šæ¥åŠ¨æ€ä¿®æ”¹æ–¹æ³•çš„å®ç°ã€‚</p>
<p>æ¯”è¾ƒå‡ºåçš„ä»¥ä¸‹æ˜¯å­—å…¸è½¬æ¨¡å‹çš„å¼€çœ¼æ¡†æ¶éƒ½åº”ç”¨äº†<code>runtime</code>ç‰¹æ€§ã€‚</p>
<p><code>Apple</code>çš„<code>KVO</code> ä¹Ÿä½¿ç”¨äº†<code>runtime</code>çš„ç‰¹æ€§ã€‚</p>
<blockquote>
<p><code>Method Swizzling</code>å°±åƒä¸€æŠŠç‘å£«å°åˆ€ï¼Œå¦‚æœä½¿ç”¨å¾—å½“ï¼Œå®ƒä¼šæœ‰æ•ˆåœ°è§£å†³é—®é¢˜ã€‚ä½†ä½¿ç”¨ä¸å½“ï¼Œå°†å¸¦æ¥å¾ˆå¤šéº»çƒ¦ã€‚åœ¨<code>stackoverflow</code>ä¸Šæœ‰äººå·²ç»æå‡ºè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼š<a href="http://stackoverflow.com/questions/5339276/what-are-the-dangers-of-method-swizzling-in-objective-c" target="_blank" rel="noopener">What are the Dangers of Method Swizzling in Objective C?</a>ï¼Œå®ƒçš„å±é™©æ€§ä¸»è¦ä½“ç°ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
</blockquote>
<blockquote>
<ul>
<li>Method swizzling is not atomic</li>
<li>Changes behavior of un-owned code</li>
<li>Possible naming conflicts</li>
<li>Swizzling changes the methodâ€™s arguments</li>
<li>The order of swizzles matters</li>
<li>Difficult to understand (looks recursive)</li>
<li>Difficult to debug</li>
</ul>
</blockquote>
<p><strong>ç»§ç»­åŠªåŠ›å§ã€‚åŠ æ²¹ï¼</strong></p>

            

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/09/lc707/" data-tooltip="707. Design Linked List" aria-label="ä¸Šä¸€ç¯‡: 707. Design Linked List">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/07/lc283/" data-tooltip="283. Move Zeroes" aria-label="ä¸‹ä¸€ç¯‡: 283. Move Zeroes">
                
                    <span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Salmons. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/09/lc707/" data-tooltip="707. Design Linked List" aria-label="ä¸Šä¸€ç¯‡: 707. Design Linked List">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">ä¸Šä¸€ç¯‡</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2016/03/07/lc283/" data-tooltip="283. Move Zeroes" aria-label="ä¸‹ä¸€ç¯‡: 283. Move Zeroes">
                
                    <span class="hide-xs hide-sm text-small icon-mr">ä¸‹ä¸€ç¯‡</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
        
            
                <li class="post-action">
                    <a class="post-action-btn btn btn--default" href="#disqus_thread">
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="5">
    <i id="btn-close-shareoptions" class="fa fa-times"></i>
    <ul class="share-options">
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/favicon.ico" alt="ä½œè€…çš„å›¾ç‰‡">
        
            <h4 id="about-card-name">Salmons</h4>
        
            <div id="about-card-bio"><p>life begins at the end of your comfort zone</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br>
                <p>Bodybuilder, SE</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br>
                China,Beijing
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-vufjrm3fmbuttogo1hxuu0w9w0sesk5iyysjuguc2hdhufot9szxg8twijry.min.js"></script>
<!--SCRIPTS END-->

    
        <script>
             var disqus_config = function () {
                 this.page.url = 'http://salmons.info/2016/03/08/Objective-C Runtime/';
                 
                    this.page.identifier = '2016/03/08/Objective-C Runtime/';
                 
             };
            (function() {
                var d = document, s = d.createElement('script');
                var disqus_shortname = 'Salmons';
                s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
            })();
        </script>
    



    </body>
</html>
